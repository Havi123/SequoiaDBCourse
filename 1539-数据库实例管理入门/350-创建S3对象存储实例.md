## 六，S3实例简介
SequoiaS3 系统实现通过 AWS S3 接口访问 SequoiaDB 的能力。

SequoiaS3 将 S3 接口中的区域、桶和对象映射为 SequoiaDB 中的集合空间，集合，记录和Lob，实现桶的增、删、查，对象的增、删、查，对象的版本管理，以及分段上传的能力，支持从 Amazon S3 或其他实现 S3 接口的存储服务平滑迁移到 SequoiaDB数据库。

### 6.1试验环境准备
在属主机上启动docker试验容器，并进入container。
```
docker run -it --privileged=true --name sdbtestfu -h sdb sdbinstance5
```
步骤在Container中执行。
S3实例目录及启动sdb进程：
``` 
su - sdbadmin
sdbstart -t all
sdblist -l

cd /opt/sequoiadb/tools/sequoias3
ls
```
S3实例相关文件和目录：

README.txt  config  log  nohup.out  sample  sequoia-s3-3.2.4.jar  sequoias3.sh

修改.profile文件，增加JAVA_HOME，在本例中已经修改：
```
cd
vi ~/.profile
```
示例配置：
```
JAVA_HOME=/opt/sequoiadb/java/jdk
CLASSPATH=$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
PATH=$JAVA_HOME/bin:$PATH
export JAVA_HOME CLASSPATH PATH
```
退出vi执行：
```
. .profile
```

### 6.2 配置sdb及S3实例

配置 SequoiaDB,SequoiaS3 对接的 SequoiaDB 需开启RC级别事务，且配置为等锁模式
```
sdb
> var db = new Sdb( "localhost", 11810 )
> db.updateConf( { transactionon:true, transisolation:1, translockwait:true} )
```
观察sdb中的集合及集合空间，目前没有：
```
> db.list(4)
Return 0 row(s).
Takes 0.002024s.
> quit
```
配置 SequoiaS3,打开 config 目录中的 application.properties 文件
```
$ vi config/application.properties
```
配置对外监听端口
```
server.port=8002
```
配置 coord 节点的 IP 和端口，可以配置多组并使用逗号分隔
```
sdbs3.sequoiadb.url=sequoiadb://localhost:11810
```
如果在 SequoiaDB 中已经为 SequoiaS3 的存储创建了专属的域，需在此处配置.在本例中不需要创建，使用缺省的domain。
```
sdbs3.sequoiadb.meta.domain=domain1
sdbs3.sequoiadb.data.domain=domain2
```
上述配置是启动 SequoiaS3 的基础配置，其他配置请参考本章末尾的配置说明。

阅读tools/sequoias3目录中的README.txt文件。
注意缺省的用户名，AccessKeyID，SecreatKeyID，本例中使用这些参数，访问S3接口：
more README.txt

默认管理员账户名：administrator
默认管理员AccessKeyID：ABCDEFGHIJKLMNOPQRST
默认管理员用户SecreatKeyID：abcdefghijklmnopqrstuvwxyz0123456789ABCD



### 6.3 启动S3实例
配置修改完成后，通过 ./sequoias3.sh 可执行脚本启动 SequoiaS3
```
./sequoias3.sh start
start sequoia-s3-3.2.4.jar
pid:1285
sequoias3(8002) is started. pid: 1285
```
查看sdb中的S3元数据表,S3实例在启动的时候如果这些元数据表不存在会自动创建：
```
sdb
> db=new Sdb()
localhost:11810
Takes 0.001103s.
> db.list(4)
{
  "Name": "S3_SYS_Meta.S3_User"
}
{
  "Name": "S3_SYS_Meta.S3_Bucket"
}
{
  "Name": "S3_SYS_Meta.S3_Region"
}
{
  "Name": "S3_SYS_Meta.S3_RegionSpace"
}
{
  "Name": "S3_SYS_Meta.S3_IDGenerator"
}
{
  "Name": "S3_SYS_Meta.S3_Task"
}
{
  "Name": "S3_SYS_Meta.S3_UploadMeta"
}
{
  "Name": "S3_SYS_Meta.S3_Part"
}
{
  "Name": "S3_SYS_Meta.S3_ACL"
}
{
  "Name": "S3_SYS_Meta.S3_ObjectMeta"
}
{
  "Name": "S3_SYS_Meta.S3_ObjectMetaHistory"
}
{
  "Name": "S3_SYS_Meta.S3_ObjectDir"
}
Return 12 row(s).
Takes 0.001152s.
> quit
```

如需停止 SequoiaS3 进程，执行 stop -p {port} 停止监听指定端口的 SequoiaS3 进程，或执行 stop -a 停止所有 SequoiaS3 进程
```
$ ./sequoias3.sh stop -p 8002
Terminating process 22754: sequoias3(8002)
```
### 6.4 操作bucket及文件对象
在本例中将使用curl restful方式来测试s3接口：
```
cd ~/s3test
```
1.创建桶sdbbucket。

在shell环境中设置变量及相关值：
```
bucket="sdbbucket"  
dateValue=`date -R`  
resource="/${bucket}/"  
contentType="application/octet-stream"  
stringToSign="PUT\n\n\n${dateValue}\n${resource}"  
s3Key="ABCDEFGHIJKLMNOPQRST"  
s3Secret="abcdefghijklmnopqrstuvwxyz0123456789ABCD"  
signature=`echo -en ${stringToSign} | openssl sha1 -hmac ${s3Secret} -binary | base64`  
```
使用curl 创建一个bucket（sdbbucket）：
```
sdbadmin@sdb:/opt/sequoiadb/tools/sequoias3/sample$ curl -v -X PUT "http://localhost:8002/${bucket}" -H "Host: localhost:8002" -H "Date: ${dateValue}" -H "Authorization: AWS ${s3Key}:${signature}"   
```
输出结果：
```
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8002 (#0)
> PUT /sdbbucket HTTP/1.1
> Host: localhost:8002
> User-Agent: curl/7.58.0
> Accept: */*
> Date: Tue, 07 Jan 2020 06:38:51 +0000
> Authorization: AWS ABCDEFGHIJKLMNOPQRST:bwJUtR+4GbJ5xFROUY1rD0OK/+E=
> 
< HTTP/1.1 200 
< location: /sdbbucket
< Content-Length: 0
< Date: Tue, 07 Jan 2020 06:53:16 GMT
< 
* Connection #0 to host localhost left intact
```

2.获取S3中的bucket信息：
```
curl -v -X GET "http://localhost:8002" -H "Host: localhost:8002" -H "Date: ${dateValue}" -H "Authorization: AWS ${s3Key}:${signature}"   
```
命令输出结果：
```
Note: Unnecessary use of -X or --request, GET is already inferred.
* Rebuilt URL to: http://localhost:8002/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8002 (#0)
> GET / HTTP/1.1
> Host: localhost:8002
> User-Agent: curl/7.58.0
> Accept: */*
> Date: Tue, 07 Jan 2020 06:38:51 +0000
> Authorization: AWS ABCDEFGHIJKLMNOPQRST:bwJUtR+4GbJ5xFROUY1rD0OK/+E=
> 
< HTTP/1.1 200 
< Content-Type: application/xml;charset=UTF-8
< Transfer-Encoding: chunked
< Date: Tue, 07 Jan 2020 07:04:27 GMT
< 
* Connection #0 to host localhost left intact
<ListAllMyBucketsResult><Owner><DisplayName>administrator</DisplayName><ID>1</ID></Owner><Buckets><Bucket><Name>sdbbucket</Name><CreationDate>2020-01-07T06:53:16.674Z</CreationDate></Bucket></Buckets></ListAllMyBucketsResult>
```
可以看到之前创建的桶sdbbucket的信息。


3.向桶中写入文件，samplefile.txt：
```
ls -l /home/sdbadmin/s3test/samplefile.txt
```
在shell环境中设置变量及相关值：
```
file=/home/sdbadmin/s3test/samplefile.txt
objname="testfile1"  
bucket=sdbbucket  
url="localhost:8002"  
resource="/${bucket}/${objname}"  
contentType="application/x-compressed-tar"  
dateValue=`date -R`  
stringToSign="PUT\n\n${contentType}\n${dateValue}\n${resource}"  
s3Key="ABCDEFGHIJKLMNOPQRST"  
s3Secret="abcdefghijklmnopqrstuvwxyz0123456789ABCD"  
signature=`echo -en ${stringToSign} | openssl sha1 -hmac ${s3Secret} -binary | base64`
```
使用curl 向sdbbucket中写入文件“samplefile。txt”，在S3中的名称是”testfile1“。
```
curl -X PUT -T "${file}" -H "Host: ${url}" -H "Date: ${dateValue}" -H "Content-Type: ${contentType}" -H "Authorization: AWS ${s3Key}:${signature}" "http://${url}/${bucket}/${objname}" 
```
4.从桶sdbbucket中读取文件对象“testfile1”，并存放到本地目录：
在shell环境中设置变量及相关值：
```
file="./mydownloadfile"  
objname="testfile1"  
bucket=sdbbucket  
url="localhost:8002"  
resource="/${bucket}/${objname}"  
contentType="application/x-compressed-tar"  
dateValue=`date -R`  
stringToSign="GET\n\n${contentType}\n${dateValue}\n${resource}"  
s3Key="ABCDEFGHIJKLMNOPQRST"  
s3Secret="abcdefghijklmnopqrstuvwxyz0123456789ABCD"  
signature=`echo -en ${stringToSign} | openssl sha1 -hmac ${s3Secret} -binary | base64`
```
使用curl 执行：
```  
curl -o ${file} -X GET -H "Host: ${url}" -H "Date: ${dateValue}" -H "Content-Type: ${contentType}" -H "Authorization: AWS ${s3Key}:${signature}" "http://${url}/${bucket}/${objname}"
```
输出结果：
``` 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 43.1M  100 43.1M    0     0  18.4M      0  0:00:02  0:00:02 --:--:-- 18.4M
```
查看新文件：
```
sdbadmin@sdb:~/s3test$ ls
mydownloadfile  myfile  samplefile.txt
```

### 6.5 在sdb中观察S3元数据。
S3的所有元数据都存储在sdb的集合中，可以在sdb命令行中查看。
```
sdb
> db=new Sdb()
```
bucket的元数据，查看创建的bucket ”sdbbucket“
```
> db.S3_SYS_Meta.S3_Bucket.find()
{
  "_id": {
    "$oid": "5e142adce4b0961c2fbc7672"
  },
  "ID": 1,
  "Name": "sdbbucket",
  "OwnerID": 1,
  "CreationDate": 1578379996674,
  "VersioningStatus": "None",
  "Region": null,
  "Delimiter": 1,
  "Delimiter1": "/",
  "Delimiter1CreateTime": 1578379996674,
  "Delimiter1ModTime": 1578379996674,
  "Delimiter1Status": "Normal",
  "Delimiter2": null,
  "Delimiter2CreateTime": null,
  "Delimiter2ModTime": null,
  "Delimiter2Status": null,
  "TaskID": null,
  "IsPrivate": true
}
Return 1 row(s).
Takes 0.008410s.
```
对象的元数据，查看上载的文件的元数据。
```
> db.S3_SYS_Meta.S3_ObjectMeta.find()
{
  "_id": {
    "$oid": "5e1432e8e4b0961c2fbc7675"
  },
  "Key": "testfile1",
  "NoVersionFlag": true,
  "BucketId": 1,
  "CSName": "S3_SYS_Data_2020_1",
  "CLName": "S3_ObjectData_Q1",
  "LobId": {
    "$oid": "5e1432dde4b0961c2fbc7674"
  },
  "VersionId": 0,
  "Etag": "853422b450e9cefda8fb49bad54577bd",
  "LastModified": 1578382056083,
  "Size": 45201941,
  "CacheControl": null,
  "ContentDisposition": null,
  "ContentEncoding": null,
  "ContentType": "application/x-compressed-tar",
  "DeleteMarker": false,
  "Expires": null,
  "ContentLanguage": null,
  "MetaList": {},
  "ParentId1": 0,
  "ParentId2": null,
  "AclID": null
}
Return 1 row(s).
```
文件对象所在的集合，这个结合由S3实例自动创建，并且缺省按照每年每个季度分表，及每个季度产生一个新的CL：
```
> db.S3_SYS_Data_2020_1.S3_ObjectData_Q1.listLobs()
{
  "Size": 45201941,
  "Oid": {
    "$oid": "5e1432dde4b0961c2fbc7674"
  },
  "CreateTime": {
    "$timestamp": "2020-01-07-07.27.25.497000"
  },
  "ModificationTime": {
    "$timestamp": "2020-01-07-07.27.36.079000"
  },
  "Available": true
}
Return 1 row(s).
Takes 0.007528s.
> quit
```

### 6.7从s3实例中删除文件和桶

在shell环境中设置变量及相关值：
```
objname="testfile1"  
bucket=sdbbucket  
url="localhost:8002"  
resource="/${bucket}/${objname}"  
contentType="application/x-compressed-tar"  
dateValue=`date -R`  
stringToSign="GET\n\n${contentType}\n${dateValue}\n${resource}"  
s3Key="ABCDEFGHIJKLMNOPQRST"  
s3Secret="abcdefghijklmnopqrstuvwxyz0123456789ABCD"  
signature=`echo -en ${stringToSign} | openssl sha1 -hmac ${s3Secret} -binary | base64`  
```
使用curl命令 删除sdbbucket中的文件对象“testfile1”。
```
sdbadmin@sdb:~/s3test$ curl  -X DELETE  -H "Host: ${url}" -H "Date: ${dateValue}" -H "Content-Type: ${contentType}" -H "Authorization: AWS ${s3Key}:${signature}" "http://${url}/${bucket}/${objname}"
```

使用curl命令，从s3中删除桶”sdbbucket“：
```
curl  -X DELETE  -H "Host: ${url}" -H "Date: ${dateValue}" -H "Content-Type: ${contentType}" -H "Authorization: AWS ${s3Key}:${signature}" "http://${url}/${bucket}"
```

在sdb中观察元数据,bucket和对象都被删除：
```
sdb

> db.S3_SYS_Data_2020_1.S3_ObjectData_Q1.listLobs()
Return 0 row(s).
Takes 0.006252s.
> db.S3_SYS_Meta.S3_ObjectMeta.find()
Return 0 row(s).
Takes 0.003769s.
> db.S3_SYS_Meta.S3_Bucket.find()
Return 0 row(s).
Takes 0.001612s.
```
执行完成，退出docker
```
$exit
#exit
```
在属主机中，删除Container
```
docker rm sdbtestfu
```