---
show: step
version: 1.0
enable_checker: true
---

## 课程介绍

#### FS实例简介
SequoiaFS文件系统是基于FUSE在Linux系统下实现的一套文件系统，支持通用的文件操作API。SequoiaFS利用SequoiaDB的元数据集合存储文件和目录的属性信息，lob对象存储文件的数据内容，从而实现了类似NFS分布式网络文件系统。用户可以将远程SequoiaDB的某个目标集合通过映射的方式挂载到本地FS节点，在FS节点的挂载目录下实现通过通用文件系统API对文件和目录进行操作。

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaFS 实例均为 3.4 版本，FUSE 版本为 2.9.4 。

## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库和 SequoiaFS 实例的操作系统用户为 sdbadmin。
```shell
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本

```shell
sequoiadb --version
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/1d1b4057ef81bc03b825926d3071183a)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```shell
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/3ebdc835c21b5685d858918d25a9f372)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤

## 环境检查及配置
#### 检查 fuse 依赖包
检查 fuse 是否安装,在本例中，已经安装了fuse 2.9.4。

```shell
fusermount --version
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/cad411da149c0e73bfe4f2508f7e26d7)


>Note: 
>
> 安装 FUSE 的方法有两种:
> - 通过 yum 或者 apt-get 在线安装，如： 
>  ```
>  apt-get install fuse
>  ```
> - 通过编译源码进行安装；
>
>


#### 查看 SequoiaFS 实例程序
```shell
ls /opt/sequoiadb/bin/sequoiafs
```


## 创建集合空间和集合
进入 SequoiaDB Shell，在 SequoiaDB 中创建测试用的集合空间和集合fscs.fscl，用于存放存储在巨杉数据库中的文件系统文件。

1）通过 Linux 命令行进入 SequoiaDB Shell；
```
sdb
```
2）通过 javascript 语言连接协调节点，获取数据库连接；
```javascript
var db = new Sdb ("localhost", 11810) ;
```

3）创建 fs_domain 逻辑域；

```javascript
db.createDomain ("fs_domain", ["group1", "group2", "group3"], { AutoSplit : true }) ;
```

4）创建 fscs 集合空间；
```javascript
db.createCS ("fscs", { Domain : "fs_domain" }) ;
```

5）创建 fscl 集合；
```javascript
db.company.createCL ("fscl", { "ShardingKey" : { "_id" : 1} , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false }) ;
```
6）退出SequoiaDB Shell；
```
quit ;
```


## 创建挂载点及配置文件
SequoiaFS 实例将集合 fscl 做为文件系统挂载到/opt/sequoiadb/mountpoint目录。

1）创建挂载点 mountpoint
```shell
mkdir -p /opt/sequoiafs/mountpoint
```

2）以 sdbadmin 用户登录，创建sequoiafs的配置文件目录和日志目录
```shell
mkdir -p /opt/sequoiafs/conf/fscs_fscl/001/
mkdir -p /opt/sequoiafs/log/fscs_fscl/001/
```

3）测试场景产生一个空配置文件，SequoiaFS 服务在启动时会将指定的值写入该文件中，其他参数使用缺省值
```shell
touch /opt/sequoiafs/conf/fscs_fscl/001/sequoiafs.conf
```


## 启动 SequoiaFS 服务

#### 通过 sequoiafs 启动服务
通过-i或者--hosts进行指定远程DB节点（协调节点），一旦挂载之后，mountpoint目录下的所有文件的属性信息会存放在远程DB节点上的目录元数据集合及文件元数据集合中，而文件内容会以lob的形式存放在目标集合下。目录元数据集合和文件元数据集合可以分别通过-d(或--metadircollection)和-f（或--metafilecollection）在进行指定，也可以直接通过指定--autocreate默认生成，该例指定默认生成。

```shell
sequoiafs /opt/sequoiafs/mountpoint -i localhost:11810 -l fscs.fscl --autocreate -c /opt/sequoiafs/conf/fscs_fscl/001/ --diagpath  /opt/sequoiafs/log/fscs_fscl/001/ -o big_writes -o max_write=131072 -o max_read=131072
```

>Note: 
>
> 挂载目录时，除了目标集合collection外，还需要指定一系列参数，具体参数选项详情请查看选项。[SequoiaFS 实例参数配置](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1525956060-edition_id-304)

#### 查看挂载目录

1）查看挂载信息,本地 SequoiaFS 节点通过mount可以看到挂载信息；

```shell
mount
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/b267eadad2dd16bfd142655e97520039)

可以看到，/opt/sequoiafs/mountpoint 已经通过 sequoiafs 已经挂载上了，文件系统类型为 fuse.sequoiafs。

2）进入 SequoiaDB Shell，在 SequoiaDB 节点可以查看相关挂载信息；

```javascript
var db=new Sdb ("localhost", 11810) ;
db.list(SDB_LIST_COLLECTIONS) ;
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/b3d240b0a7a56fa8586b5ff10522831a)

3）进入 SequoiaDB Shell，在 SequoiaDB 节点中查看映射挂载历史信息；

对于每次 mount，可以通过以上5张表查看相关信息，后续会介绍各表的作用，sequoiafs.maphistory 为映射挂载历史信息表，记录历史挂载的关键数据信息。 

```javascript
db.sequoiafs.maphistory.find() ;
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/78ef3a0dc12cc431fcec4dcb2e0a3434)

>Note: 
>
> - 对于每次 mount，可以通过 sequoiafs.maphistory 查看映射挂载历史信息。  
> - 历史信息记录中描述说明：SourceCL：目标映射集合名称，DirMetaCL：目录元数据集合名称，FileMetaCL：文件元数据集合名称，Address：FS节点地址，MountPoint：FS节点挂载时的目录。  
> - sequoiafs.fscl_dir 和 fscl_file 分别为目录和文件的元数据集合表，由于 SequoiaFS 启动挂载时指定了--autocreate，所以这里是默认生成的，用以记录 FS 挂载目录下的目录和文件信息。

##  挂载目录下文件、目录操作

#### 测试创建目录

以 sdbadmin 用户登录，进入到 /opt/sequoiafs/mountpoint/ 中，创建目录 fsdir 并查看：

1）进入挂载目录；

```shell
cd /opt/sequoiafs/mountpoint/
```

2）创建目录；

```shell
mkdir fsdir
```

3）查看目录是否存在；

```shell
ls -trl
```

#### 测试创建文件并写入内容

以 sdbadmin 用户登录，进入到 /opt/sequoiafs/mountpoint/fsdir 中，创建文件 fsfile 并写入内容。

1）进入测试创建的 fsdir 目录；
```shell
/opt/sequoiafs/mountpoint/fsdir
```

2）使用 echo 重定向内容创建文件；

```shell
echo 'hello, this is a fsfile!' >> fsfile.txt
```

3）查看文件内容是否存在；
```shell
cat fsfile.txt
```

## 查看在挂载目录创建的文件及目录对应的数据库存储内容
1）进入 SequoiaDB Shell，查看文件和目录是否在 SequoiaDB 数据库存储引擎中存储情况；

通过 Linux 命令行进入 SequoiaDB Shell；
```
sdb
```

通过 javascript 语言连接协调节点，获取数据库连接；
```javascript
var db = new Sdb ("localhost", 11810) ;
```

查看在存储引擎中存储情况；

```javascript
db.sequoiafs.fscl_file142361856883863522.find();
db.sequoiafs.fscl_dir142361856883863522.find();
```

退出SequoiaDB Shell；
```
quit ;
```




操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/35a81a47a0ddef349c3b7dc3cc9700ac)

>Note: 
>
> fscl_file142361856883863522,fscl_dir142361856883863522是自动产生的，可能和课程中产生的不一样，可以使用: db.list(SDB_LIST_COLLECTIONS)查看。


#### 删除文件和目录
1）以 sdbadmin 用户登录，进入到/opt/sequoiafs/mountpoint中，删除文件fsfile和目录fsdir：
```
cd /opt/sequoiafs/mountpoint
ls
rm -R fsdir
ls
```

2）进入 SequoiaDB Shell，查看文件和目录是否删除成功：
通过 Linux 命令行进入 SequoiaDB Shell；
```
sdb
```

通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost", 11810) ;
```

查看在存储引擎中存储情况；

```javascript
db.sequoiafs.fscl_file142361856883863522.find();
db.sequoiafs.fscl_dir142361856883863522.find();
```

退出SequoiaDB Shell；
```
quit ;
```


## 总结

通过本课程，我们验证了 SequoiaDB 巨杉数据库所支持的 NFS 文件系统存储。可以看出： SequoiaFS 实例支持通过操作系统文件系统接口访问 SequoiaDB 巨杉数据库存储引擎；
