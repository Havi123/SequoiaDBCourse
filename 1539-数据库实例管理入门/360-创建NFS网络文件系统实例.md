---
show: step
version: 1.0
enable_checker: true
---
# FS实例简介
SequoiaFS文件系统是基于FUSE在Linux系统下实现的一套文件系统，支持通用的文件操作API。SequoiaFS利用SequoiaDB的元数据集合存储文件和目录的属性信息，lob对象存储文件的数据内容，从而实现了类似NFS分布式网络文件系统。用户可以将远程SequoiaDB的某个目标集合通过映射的方式挂载到本地FS节点，在FS节点的挂载目录下实现通过通用文件系统API对文件和目录进行操作。
## 1 试验环境准备
课程环境是一个docker 容器，已经安装了一个单副本的巨杉数据库，包括了多种实例的安装介质，可以在这容器中完成多种实例的安装配置。

在属主机上启动docker试验容器，并进入container。
```
docker run -it --privileged=true --name sdbtestfu -h sdb sdbinstance5
```
以下步骤在Container中执行。
sequoiaFS目录,启动sdb：
```
su - sdbadmin
sdbstart -t all
sdblist -l
```
修改.profile文件，增加JAVA_HOME，在本例中已经修改：
```
cd
vi ~/.profile

JAVA_HOME=/opt/sequoiadb/java/jdk
CLASSPATH=$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
PATH=$JAVA_HOME/bin:$PATH
export JAVA_HOME CLASSPATH PATH
```
退出vi执行：
```
. .profile
```

查看FS实例程序：
```
cd /opt/sequoiadb/bin
ls -l sequoiafs
```
使用root用户，把sequoiafs程序拷贝到/usr/local/bin目录：
```
cd /opt/sequoiadb/bin
 chmod +x sequoiafs 
 cp sequoiafs  /usr/local/bin/
 which sequoiafs
/usr/local/bin/sequoiafs
```
检查fuse是否安装,在本例中，已经安装了fuse 2.9.7.
```
# which fusermount
/usr/local/bin/fusermount
# fusermount --version
fusermount version: 2.9.7
```
	
## 2 在sdb中创建测试用的集合空间和集合，fscs.fscl
这个集合用于存放存储在巨杉数据库中的文件系统文件。

```
su - sdbadmin

sdb
var db=new Sdb("localhost",11810)
> db.list(4)
Return 0 row(s).
Takes 0.005234s.
db.createCS("fscs")
db.fscs.createCL("fscl")
> db.list(4)
{
  "Name": "fscs.fscl"
}
Return 1 row(s).
Takes 0.001115s.
> quit
```

## 3 把fscl做为文件系统挂载到/opt/sequoiadb/mountpoint目录

创建挂载点
sdbadmin用户：
```
mkdir -p /opt/sequoiadb/mountpoint

chown sdbadmin:sdbadmin_group /opt
```
创建sequoiafs的配置文件目录和日志目录
```
mkdir -p /opt/sequoiafs/conf/fscs_fscl/001/
mkdir -p /opt/sequoiafs/log/fscs_fscl/001/
```
测试场景产生一个空配置文件，使用缺省值
```
touch /opt/sequoiafs/conf/fscs_fscl/001/sequoiafs.conf
```

挂载目录时，除了目标集合collection外，还需要指定一系列参数，具体参数选项详情请查看选项。。

通过-i或者--hosts进行指定远程DB节点（协调节点），一旦挂载之后，mountpoint目录下的所有文件的属性信息会存放在远
程DB节点上的目录元数据集合及文件元数据集合中，而文件内容会以lob的形式存放在目标集合下。目录元数据集合和文件元数据集合可
以分别通过-d(或--metadircollection)和-f（或--metafilecollection）在进行指定，也可以直接通过指定--autocreate默认生成，该例指定默认生成。
```
sdbadmin@sdb:~$ sequoiafs /opt/sequoiadb/mountpoint -i localhost:11810 -l fscs.fscl --autocreate -c /opt/sequoiafs/conf/fscs_fscl/001/ --diagpath  /opt/sequoiafs/log/fscs_fscl/001/ -o big_writes -o max_write=131072 -o max_read=131072
```

查看挂载信息,本地FS节点通过mount可以看到挂载信息.
```
mount
```
输出结果：
```
overlay on / type overlay (rw,relatime,seclabel,lowerdir=/var/lib/docker/overlay2/l/DI4PSN6ELCXDXK443564WEXB7Y:/var/lib/docker/overlay2/l/NWZWM4A4OYC3WO6ADRVQQV6T2V:/var/lib/docker/overlay2/l/WFL5M2RHD62FQ7SLAFGSCE3TRH:/var/lib/docker/overlay2/l/SYJHIX4TNODUAPSPGCLWSTKODN:/var/lib/docker/overlay2/l/WZUFVHXOULMW2IFRZOOTU6VJ7N:/var/lib/docker/overlay2/l/EM56OX6PUQKUELGE7BH46VPL7B:/var/lib/docker/overlay2/l/MBSJJIS6IRXO35NR7JMZ2JN3SA,upperdir=/var/lib/docker/overlay2/24b08d093bdae298061ecf21280811fd80dad666169d262df0a3154c637c44a8/diff,workdir=/var/lib/docker/overlay2/24b08d093bdae298061ecf21280811fd80dad666169d262df0a3154c637c44a8/work)
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
tmpfs on /dev type tmpfs (rw,nosuid,seclabel,size=65536k,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,seclabel,gid=5,mode=620,ptmxmode=666)
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime,seclabel)
tmpfs on /sys/fs/cgroup type tmpfs (rw,nosuid,nodev,noexec,relatime,seclabel,mode=755)
cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)
cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio,net_cls)
cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)
cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct,cpu)
cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)
cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
mqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime,seclabel)
shm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,seclabel,size=65536k)
/dev/mapper/centos-root on /etc/resolv.conf type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/hostname type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/hosts type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
devpts on /dev/console type devpts (rw,nosuid,noexec,relatime,seclabel,gid=5,mode=620,ptmxmode=666)
sequoiafs on /opt/sequoiadb/mountpoint type fuse.sequoiafs (rw,nosuid,nodev,relatime,user_id=1000,group_id=1000,max_read=131072)
```
可以看到，/opt/sequoiadb/mountpoint已经通过sequoiafs已经挂载上了，文件系统类型为fuse.sequoiafs。

在DB节点可以查看相关挂载信息。
```
sdb
> var db = new Sdb("localhost", 11810) 
Takes 0.001705s.
> db.list(4)
{
  "Name": "fscs.fscl"
}
{
  "Name": "sequoiafs.fscl_dir142361856883863522"
}
{
  "Name": "sequoiafs.fscl_file142361856883863522"
}
{
  "Name": "sequoiafs.maphistory"
}
{
  "Name": "sequoiafs.sequenceid"
}
```
对于每次mount，可以通过以上5张表查看相关信息，后续会介绍各表的作用，sequoiafs.maphistory为映射挂载历史信息表，记录历史挂载的关键数据信息。 
```
> db.sequoiafs.maphistory.find()
{
  "_id": {
    "$oid": "5e1446c403418412fd89a1c7"
  },
  "SourceCL": "fscs.fscl",
  "DirMetaCL": "sequoiafs.fscl_dir142361856883863522",
  "FileMetaCL": "sequoiafs.fscl_file142361856883863522",
  "Address": "eth0:172.17.0.2;",
  "MountPoint": "/opt/sequoiadb/mountpoint",
  "MountTime": {
    "MountTime": "2020-01-07-08.52.20.080753"
  }
}
Return 1 row(s).
Takes 0.004797s.

> quit
```
每次挂载时都会记录一条历史数据，以供历史查询，其基本含义如下： 

记录名称 描述说明 
SourceCL 目标映射集合名称 
DirMetaCL 目录元数据集合名称 
FileMetaCL 文件元数据集合名称 
Address FS节点地址 
MountPoint FS节点挂载时的目录 

sequoiafs.sequenceid为目录元数据中目录记录的id序列表，目的用于构造目录的唯一性。 

sequoiafs.bar_dir148139183721030和sequoiafs.bar_file148139183721030分别为目录和文件的元数据集合表，由于SequoiaFS启动挂载时指定了--autocreate，所以这里是默认生成的，用以记录FS挂载目录下的目录和文件信息。

## 4 在FS节点挂载目录下创建文件和目录
```
$ cd /opt/sequoiadb/mountpoint/
ls
$ touch testfile
$ echo 'hello, this is a testfile!' >> testfile
$ cat testfile 
hello, this is a testfile!
ls
$ mkdir testdir
$ ls
testdir  testfile
```
上面我们在FS挂载目录下创建了文件testfile并写入'hello, this is a testfile!'，并创建了子目录testdir。在DB节点查看目录元数据集合，可以查到testdir目录元数据信息记录。

fscl_file142361856883863522是自动产生的，可能和课程中产生的不一样，可以使用: db.list(4)查看。
```
sdb
db=new Sdb()
> db.sequoiafs.fscl_file142361856883863522.find()
{
  "AccessTime": 1578387527247,
  "CreateTime": 1578387527243,
  "Gid": 1000,
  "LobOid": "00005e144840360002c2120b",
  "Mode": 33188,
  "ModifyTime": 1578387527247,
  "NLink": 1,
  "Name": "testfile",
  "Pid": 1,
  "Size": 23,
  "SymLink": "",
  "Uid": 1000,
  "_id": {
    "$oid": "5e14484703418412fd89a1c8"
  }
}
Return 1 row(s).
Takes 0.005751s.

> db.sequoiafs.fscl_dir142361856883863522.find()
{
  "_id": {
    "$oid": "5e14487603418412fd89a1c9"
  },
  "Name": "testdir",
  "Mode": 16877,
  "Uid": 1000,
  "Gid": 1000,
  "Pid": 1,
  "Id": 2,
  "NLink": 2,
  "Size": 4096,
  "CreateTime": 1578387574340,
  "ModifyTime": 1578387574340,
  "AccessTime": 1578387574340,
  "SymLink": ""
}
Return 1 row(s).
Takes 0.001073s.
> quit
```

在mount点删除文件和目录:
```
cd /opt/sequoiadb/mountpoint
ls
rm -rf testfile
rm -R testdir
ls
```
## 5 停止FS实例运行，并退出Container：

fusermount卸载文件系统mount点，sequoiafs进程自动停止运行。
```
$fusermount -u /opt/sequoiadb/mountpoint
ps -C sequoiafs
```
## 结束课程

执行完成，退出docker
```
$exit
#exit
```
在属主机中，删除Container
```
docker rm sdbtestfu
```