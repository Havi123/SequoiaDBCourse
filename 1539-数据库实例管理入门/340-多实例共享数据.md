---
show: step
version: 1.0
enable_checker: true
---
# 多实例共享数据

## 课程介绍

#### 多实例数据共享简介

在本例中将试验多个实例共存的情况，包括：SequoiaDB-MySQL，SequoiaDB-PostgreSQL，SparkSQL，JSON 实例。
在第上个示例中我们创建了sparksql实例，并使用mysql实例存储元数据；在本例中将增加一个postgresql实例，并且演示在MySQL实例中插入数据，
然后通过postgresql和sparksql进行数据分析的过程。

## MySQL 实例产生数据
1）使用 MySQL Shell 连接 SequoiaSQL-MySQL 实例；
```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```
2）检查现有数据库；
```
show databases ;
```

3）创建数据库实例，并切换到该数据库；
```
create database company ;
use company;
```
4）创建包含自增主键字段的 employee 表；

```sql
CREATE TABLE employee (empno INT AUTO_INCREMENT PRIMARY KEY, ename VARCHAR(128), age INT) ;
```

5）进行基本的数据写入操作；

```sql
INSERT INTO employee (ename, age) VALUES ("Jacky", 36) ;
INSERT INTO employee (ename, age) VALUES ("Alice", 18) ;
```

6）退出 MySQL Shell；
```shell
\q
```

## JSON 实例中访问数据

1）使用 Linux 命令行进去 SequoiaDB Shell；
```
sdb
```
2）使用javascript 语法连接协调节点，获取数据库连接；
```
var db=new Sdb("localhost", 11810) ;
```

3）查看sequoiadb中的集合信息；
```
db.list(SDB_LIST_COLLECTIONS) ;
```
操作截图：
4）查找 employee 中的数据，查看是否为 SequoiaDB-MySQL 实例中插入的数据；

```
db.company.employee.find() ;
```

5）退出 SequoiaDB Shell；
```
quit ;
```


## 在 SequoiaDB-PostgreSQL 实例中访问数据

#### 创建 PostgreSQL 实例

1）进入 SequoiaSQL-PostgreSQL 实例安装目录；
```
cd /opt/sequoiasql/postgresql
```

2）查看 PostgreSQL 实例情况；
```
./bin/sdb_sql_ctl status
```

预期输出：
INSTANCE   PID        SVCNAME    SQLDATA                                  SQLLOG                                  
Total: 0; Run: 0
没有实例

3）创建 PostgreSQL 实例；
```
./bin/sdb_sql_ctl addinst myinst -D database/5432/
```

4）检查创建的实例状态；
```
./sdb_sql_ctl status
```
5）如果未展示，启动pgsql实例；
```
./bin/sdb_sql_ctl start myinst
```

6）检查创建的实例状态；
```
./sdb_sql_ctl status
```

#### 创建数据库及配置实例

1）创建 company 数据库实例；
```
./sdb_sql_ctl createdb company myinst
```

2）进入 PostgreSQL shell；
```
./bin/psql -p 5432 company
```

3）加载SequoiaDB连接驱动；
```
create extension sdb_fdw ;
```

4）配置与SequoiaDB连接参数；
```
pgsdb=# CREATE SERVER sdb_server FOREIGN DATA WRAPPER sdb_fdw OPTIONS(address '127.0.0.1', service '11810', preferedinstance 'A', transaction 'off') ;
```
5）退出PostgreSQL shell；
```
\q
```
#### 关联 PostgreSQL 实例关联 SequoiaDB 的集合空间与集合
1）进入 PostgreSQL Shell 命令行；

```
./bin/psql -p 5432 company
```

2）创建 company 数据库外表；
```
CREATE FOREIGN TABLE employee (
  empno integer, 
  ename text,
  age integer
) SERVER sdb_server 
  OPTIONS ( collectionspace 'company', collection 'employee', decimal 'on') ;
```

3）更新表的统计信息；
```
analyze employee ;
```
4）查询 employee 表中的数据；

```
select * from employee ;
```



## 4 在 SparkSQL 实例中访问数据

1）进入 SparkSQL 实例安装目录；
```
cd /opt/spark-2.1.3-bin-hadoop2.7/
```

2）进入 beeline 客户端测试 sql；

```shell
bin/beeline
```

3）连接10000端口获取 thriftserver 连接；
```
!connect jdbc:hive2://localhost:10000
```

4）创建 company 数据库；
```
CREATE DATABASE company ;
```

5）创建映射表；

```
CREATE TABLE company.employee(
empno int,
ename string,
age int
) USING com.sequoiadb.spark OPTIONS ( host 'localhost:11810' ,collectionspace 'company', collection 'employee', username '',password '') ;
```

6）测试运行 sql；
```
SELECT avg(age) FROM company.employee ;
```

## 总结
本课程通过在 SequoiaDB-MySQL 实例上创建数据库和数据表，并向数据表中插入数据，使底层存储 SequoiaDB 巨杉数据库引擎同步创建分区表，再使用 JSON 实例、SequoiaDB-PostgreSQL 实例和 SparkSQL 实例查询该分区表证明了多实例的之间的数据是共享的。

