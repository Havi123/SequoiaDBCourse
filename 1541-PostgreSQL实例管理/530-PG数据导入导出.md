---
show: step
version: 1.0
enable_checker: true
---

# PostgreSQL实例数据导入导出


## 课程介绍
本课程主要讲解 PostgreSQL 数据库的导入导出操作， 其中包含 CSV 格式导入导出和基于 pg_dump 工具的导入导出。

#### 请点击右侧选择使用的实验环境

#### 部署架构
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-PostgreSQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据分区，9个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/ef825173c9cd86053b61306ca6df9c65)


详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)


#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-PostgreSQL 实例均为 3.4 版本。



## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库和 SequoiaSQL-MySQL 实例的操作系统用户为 sdbadmin。
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本

```
sequoiadb --version
```
操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/b4082b0d6d6bdf89d229aa713a53759d)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/02fcaa58ac27e91688ead137fa748d6e)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤

#### 检查 PostgreSQL 实例进程

查看 PostgreSQL 数据库实例
```
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl listinst
```

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/92856e2e05fee65495cb876332cd34c6)

查看数据库实例进程
```
ps -elf | grep postgre
```

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/41b259ef9f2b7f16466b3d89606998c4)






#### 在 SequoiaDB 中建立集合空间和集合

1）使用 Linux 命令进入 SequoiaDB Shell 命令行

```
sdb
```

2）使用 JavaScript 语法，连接协调节点，获取数据库连接。

```javascript
var db = new Sdb ( "localhost", 11810 ) ;
```

3）创建 company_domain 逻辑域

```javascript
db.createDomain ( "company_domain", ["group1", "group2", "group3"], { AutoSplit : true } ) ;
```

4）创建 company 集合空间

```javascript
db.createCS ( "company", { Domain: "company_domain" } ) ;
```

5）创建 employee 集合

```javascript
db.company.createCL ( "employee", { "ShardingKey" : { "_id" : 1 } , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false } ) ;
```

6）写入测试数据；

```javascript
for (var i = 0 ; i < 1000 ; i++) { db.company.employee.insert ({ empno:i , ename : "TEST", age : 20 }) }
```

7）退出 SequoiaDB Shell；

```
quit
```
## 配置 PostgreSQL 实例
#### 加载 SequoiaDB 连接驱动
1）登录到 PostgreSQL 实例 Shell；
```shell
/opt/sequoiasql/postgresql/bin/psql -p 5432 company
```

2）加载SequoiaDB连接驱动；
```sql
CREATE EXTENSION sdb_fdw ;
```

#### 配置与 SequoiaDB 连接参数
在 PostgreSQL 实例中配置 SequoiaDB 连接参数：
```sql
CREATE SERVER sdb_server FOREIGN DATA WRAPPER sdb_fdw 
    OPTIONS (address '127.0.0.1', service '11810', user '', password '', preferedinstance 'A', transaction 'on' ) ;
```

#### 实例与数据引擎中集合关联

1）将 PostgreSQL 实例中的外表并与 SequoiaDB 中的集合空间、集合关联；

```sql
CREATE FOREIGN TABLE employee (
     empno INT,
     ename VARCHAR(128),
     age INT
  ) 
  SERVER sdb_server
  OPTIONS ( collectionspace 'company', collection 'employee', decimal 'on' ) ;
```

2）查询数据，验证是否能够访问数据引擎；

```sql
SELECT * FROM employee LIMIT 1 ;
```


## 数据导出

1）通过COPY (SELECT...)命令将外部表purchaseorder的数据导出为.csv文件；

```
COPY (SELECT * FROM employee) TO  './employee.csv' with delimiter ','  csv;
```
2）查看csv文件内容
```
\! more ./employee.csv
```

> 注：!前包含反斜线“\”，

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/2c115e06afb6d6be687da01c92130384)

3）退出PostgreSQL Shell；

```
\q
```

## 数据导入

PostgreSQL的COPY FORM命令不支持直接向外部表中导入数据，一旦数据需要恢复，可以用SequoiaDB的导入工具sdbimprt完成向集合的数据导入。

#### 清空 employee 集合内数据

1）使用 Linux 命令进入 SequoiaDB Shell 命令行；

```
sdb
```

2）使用 JavaScript 语法，连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ( "localhost", 11810 ) ;
```

3）统计数据量；
```javascript
db.company.employee.count() ;
```


4）清空集合内数据；

```javascript
db.company.employee.truncate() ;
```

5）验证是否被清空，查询结果为0；
```javascript
db.company.employee.count() ;
```

#### 导入数据

1）通过 sdbimprt 工具从备份文件中恢复数据到 employee 数据集合中。

```
sdbimprt --hosts=localhost:11810 --type=csv --file=/opt/sequoiasql/postgresql/employee.csv --fields="empno int, ename string, age int"  -c company -l employee
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/7eacfa26fdb900a41d53d4e0e7f25a93)


2）登录到 PostgreSQL 实例 Shell；
```shell
/opt/sequoiasql/postgresql/bin/psql -p 5432 company
```


3）PostgreSQL shell中验证数据访问；
```
SELECT COUNT(*) FROM employee ;
```

4）退出PostgreSQL Shell；
```
\q
```

## 总结




