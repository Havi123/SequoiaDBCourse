**MySQL实例管理**
**挑战介绍**
PostgreSQL 是一款开源的关系型数据库管理系统，也是目前最流行的关系型数据库管理系统之一，支持标准的 SQL 语言。 SequoiaDB 支持创建 PostgreSQL 实例，完全兼容 PostgreSQL  语法和协议，用户可以使用 SQL 语句访问 SequoiaDB 数据库，完成对数据的增、删、查、改操作以及其它PostgreSQL 语法操作。
SequoiaDB 支持 PostgreSQL 9.3.4 版本
此挑战是对PostgreSQL的事务管理, 熟悉PostgreSQL实例的操作。
**知识点**
1）创建PostgreSQL实例
2）在SequoiaDB数据库中, 创建集合空间与集合，插入样例数据
3）在PostgreSQL实例中，创建与SequoiaDB集合的关联
4）PostgreSQL实例操作与事务处理
5）通过PostgreSQL数据导入/导出
**挑战内容**
1）在SequoiaDB数据库创建 sample 集合空间和集合employee, 插入数据记录（id:10001, name:'Georgi', age:48）;
2）创建一个新的 PostgreSQL实例 myinst1, 在PostgreSQL实例myinst1中，创建sample数据库；
3）加载SequoiaDB连接驱动，配置与SequoiaDB的连接参数并创建server，创建外部表employee与SequoiaDB的employee集合的关联；
4）查询employee外部表，开始PostgreSQL事务，插入新的数据记录(id:10002, name:'Bezalel', age:21)，提交事务，查询employee外部表；
5）开始PostgreSQL事务，插入新的数据记录(id:10003, name:'lazhu', age:22), 查询 employee 外部表信息，回滚事务, 再次查询 employee 外部表信息，确认插入操作已回滚；
6）通过COPY（select...）命令将外部表employee的数据导出为employee.csv文件, 清空 employee 外部表数据；
7）通过SequoiaDB的sdbimprt数据导入工具，从备份文件employee.csv中将数据导入集合employee中；
8）在PostgreSQL实例myinst1的sample数据库中，查询外部表employee，确认数据恢复情况;

**挑战要求**
1）正确创建PostgreSQL数据库实例
2）正确建立PostgreSQL外部表与SequoiaDB数据集合的关联
3）正确执行数据插入操作，执行事务的提交和回滚操作
4）正确对表数据信息执行导入导出操作

**示例代码**

SequoiaDB创建集合空间与集合，插入数据

sdb

db = new Sdb()

db.createCS("sample").createCL("employee")

db.sample.employee.insert({id:10001,name:"Georgi",age:48})

quit

创建PostgreSQL数据库实例 myinst1, 创建sample数据库;

cd /opt/sequoiasql/postgresql

bin/sdb_sql_ctl addinst myinst1 -D database/5433/ -p 5433

bin/sdb_sql_ctl start myinst1

bin/createdb sample -p 5433

加载SequoiaDB连接驱动，配置与SequoiaDB的连接参数并创建server，创建外部表employee与SequoiaDB的employee集合的关联；

psql -d sample -p 5433

create extension sdb_fdw;

create server sdb_server foreign data wrapper sdb_fdw options(address '127.0.0.1', service '11810', user 'sdbadmin', password 'sdbadmin', preferedinstance 'A', transaction 'on');

create foreign table employee(id int, name char(10), age int) server sdb_server options ( collectionspace 'sample', collection 'employee', decimal 'on' ) ;

查询employee外部表，开始PostgreSQL事务，插入新的数据记录(id:10002, name:'Bezalel', age:21)，提交事务，查询employee外部表；

select * from employee;
   id   |    name    | age 
-------+------------+---------
 10001 | Georgi  |  48
(1 row)

begin work;

insert into employee values(10002, 'Bezalel', 21);

commit;

select * from employee;
  id   |    name    | age 
-------+------------+----------
 10001 | Georgi  |  48
 10002 | Bezalel |  21
(2 rows)

开始PostgreSQL事务，插入新的数据记录(id:10003, name:'lazhu', age:22), 查询 employee 外部表信息，回滚事务, 再次查询 employee 外部表信息，确认插入操作已回滚；

begin work;

insert into employee values(10003, 'lazhu', 22);

select * from employee;
  id   |    name    | age 
-------+------------+---------
 10001 | Georgi   |  48
 10002 | Bezalel  |  21
 10003 | lazhu     |  22
(3 rows)

 rollback;

select * from employee;
  id   |    name    | age 
-------+------------+--------
 10001 | Georgi   |  48
 10002 | Bezalel  |  21
(2 rows)

 将外部表employee的数据导出为employee.csv文件, 清空 employee 外部表数据；

COPY (select * from employee) TO  './employee.csv' with delimiter ','  csv;

\! more employee.csv       --注：!前包含反斜线“\”
10001,Georgi    ,48
10002,Bezalel   ,21

delete from employee;

DELETE 2

select * from employee;

 id | name | age 
----+------+-----
(0 rows)

\q

通过SequoiaDB的sdbimprt数据导入工具，从备份文件employee.csv中将数据恢复集合employee中；

sdbimprt --hosts=localhost:11810 --type=csv --file=/opt/sequoiasql/postgresql/employee.csv --fields="id int , name string , age int " --datefmt "YYYY-MM-DD" -c sample -l employee

parsed records: 2
parse failure: 0
sharding records: 0
sharding failure: 0
imported records: 2
import failure: 0

在PostgreSQL实例myinst1的sample数据库中，查询外部表employee，确认数据恢复情况;

psql -d sample -p 5433

select * from employee;
  id   |    name    | age 
-------+------------+--------
 10001 | Georgi   |  48
 10002 | Bezalel  |  21
(2 rows)

\q

