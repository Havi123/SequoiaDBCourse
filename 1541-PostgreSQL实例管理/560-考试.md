# 考试

## 挑战PostgreSQL实例的日常管理

#### 知识点

1）PostgreSQL 数据库实例使用

2）PostgreSQL 实例的事务操作

3）PostgreSQL 表数据的导出

4）SequoiaDB 逻辑域、集合空间和集合的创建

#### 挑战介绍

PostgreSQL 是一款开源的关系型数据库，支持标准 SQL，用户可以通过 JDBC 驱动连接 PostgreSQL 进行应用程序开发。SequoiaDB 支持创建 PostgreSQL 实例，完全兼容 PostgreSQL 语法，用户可以使用 SQL 语句访问 SequoiaDB 数据库，完成对数据的增、删、查、改及其他操作。

SequoiaDB 支持 PostgreSQL 9.3.4 版本

此挑战是在对接好的 SequoiaDB 和 PostgreSQL 环境下，创建 SequoiaDB 逻辑域、集合空间和集合，创建 PostgreSQL 实例并进行事务管理操作，PostgreSQL 数据的导出，熟悉 PostgreSQL 的操作。

## 挑战内容

1）创建 company_domain 逻辑域，包含 group1、group2、group3 三个复制组；

2）创建 company 集合空间，所属 company_domain 逻辑域；

3）创建 employee 集合，集合使用 id 字段作为切分键、hash 分区、开启数据压缩功能并使用 lzw 压缩算法类型、开启自动切分功能、关闭自动创建 “$shard” 索引，要求写请求需同步到该复制组若干活跃的节点之后，数据库写操作才返回应答给客户端；

4）创建实例 pginst，端口使用 5433；

5）在 PostgreSQL 创建 company 数据库和 employee 外部表映射到 SequoiaDB 数据库的 company.employee 集合；

6）创建事务 work，插入 employee 表数据 (id:10001, name:'Georgi', age:48)，提交事务，然后查询 employee 表；

7）将 employee 表数据导出到 “/opt/sequoiasql/postgresql/employee.csv”，使用 “\! more /opt/sequoiasql/postgresql/employee.csv” 命令查看数据内容；

## 挑战要求

1）正确创建 SequoiaDB 的逻辑域、集合空间和集合；

2）正确创建 PostgreSQL 映射表；

3）学会用 PostgreSQL 使用事务；

4）准确导出 PostgreSQL 表数据，并查看数据内容；


## 示例代码

1）登陆操作系统用户 sdbadmin；

```shell
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为`sdbadmin`

2）创建 SequoiaDB 逻辑域、集合空间和集合；

```javascript
sdb
var db = new Sdb ( "localhost", 11810 ) ;
db.createDomain ( "company_domain", ["group1", "group2", "group3"], { AutoSplit : true } ) ;
db.createCS ( "company", { Domain: "company_domain" } ) ;
db.company.createCL ( "employee", { "ShardingKey" : { "id" : 1 } , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false } ) ;
```

3）退出 SequoiaDB Shell；

```shell
quit ;
```

4）创建 PostgreSQL 实例和数据库；

```shell
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl addinst pginst -D database/5432/ -p 5432
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl start pginst
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl createdb company pginst
/opt/sequoiasql/postgresql/bin/psql -p 5433 company
```

5）建立连接；

```sql
CREATE EXTENSION sdb_fdw ;
CREATE SERVER sdb_server FOREIGN DATA WRAPPER sdb_fdw OPTIONS (address '127.0.0.1', service '11810', user '', password '', preferedinstance 'A', transaction 'on' ) ;
CREATE FOREIGN TABLE employee (id int, name text, age int) SERVER sdb_server options ( collectionspace 'company', collection 'employee', decimal 'on' ) ;
```

6）开始事务；

```sql
BEGIN work ;
INSERT INTO employee VALUES (10001, 'Georgi', 48) ;
COMMIT ;
SELECT * FROM employee ;
```

7）导出数据；

```
COPY (SELECT * FROM employee) TO '/opt/sequoiasql/postgresql/employee.csv' with delimiter ',' csv;
\! more /opt/sequoiasql/postgresql/employee.csv
\q
```

