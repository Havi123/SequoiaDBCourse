**PostgreSQL实例操作及事务管理**

**课程介绍**

创建样例数据库sample，完成PostgreSQL实例操作和事务管理

**首先，进入/opt/sequoiadb/samples目录，解压样例数据库samples.tar包：**

cd /opt/sequoiadb/samples

tar xvf samples.tar

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/6912a284f174ed9e36d334fcf0210340)

**进入/opt/sequoiadb/samples/samples目录，运行sample_database.sh创建样例数据库sample，加载样例数据：**

cd samples

./sample_database.sh

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/ba92b84d67fe2a18a6df7e89c52f7386)

**验证SequoiaDB集合空间样例数据：**

sdb

Welcome to SequoiaDB shell!
help() for help, Ctrl+c or quit to exit

db = new Sdb()
localhost:11810
Takes 0.025680s.

**列出所有集合信息：**

db.listCollections()

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/db080614c4c6a68d368157e6797a5fa5)

**查询customer集合中的数据：**

db.sample.customer.find()

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/d0d7f12d06d3c9a1b2c66b23f5802e92)

**查询purchaseorder集合中的数据**

db.sample.purchaseorder.find()

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/1f6fa7b6f521f5fa78f82cf9a4c14b81)

**退出**

quit

**进入PostgreSQL shell环境：**

cd /opt/sequoiasql/postgresql

psql -d sample

psql (9.3.4)
Type "help" for help.

sample=# 

**查看PostgreSQL中foreign table所对应的SequoiaDB数据库中集合空间和集合信息：**

\d

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/faf8df516d48abec3f5d51f00c607bbe)

**PostgreSQL基本操作：**

**通过PostgreSQL的foreign table查询SequoiaDB数据库中的数据：**

select * from customer;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/d069f8b69a32ca02fb33eaae4695a231)

select * from purchaseorder;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/b0238da3e49b89168fd45ed5a440c68f)

**关联数据访问：**

select * from purchaseorder a, customer b where a.custid = b.cid;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/794649798d83c999cafd3dbd6632b6c1)

**插入数据：**

insert into purchaseorder values(5007,'Unshipped',1001,current_date,''); 
INSERT 0 1

select * from purchaseorder;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/3270053ec072072aea2fc3380a7a48ab)

**更新数据：**

update purchaseorder set status = 'Shipped' where poid = 5000;
UPDATE 1

select * from purchaseorder;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/521274b4f79bab974b56607b1c8229cf)

**删除数据：**

delete from purchaseorder where poid = 5007;
DELETE 1

select * from purchaseorder;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/04c16a6c102cdf739f8dbd003ae6861b)

**创建视图：**

select * from employee;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/b4afc47d10ae61ebea48646aaabff3d0)

create view emp_view as select empno,firstnme,lastname,phoneno,job,sex,birthdate from employee;
CREATE VIEW

select * from emp_view;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/8d66d8242ae865a061566585101e78f4)

**创建自定义函数：**

CREATE OR REPLACE FUNCTION totalRecords ()                                                                                                          RETURNS integer AS $total$                                                                                                                                   declare   total integer;  BEGIN                                                                                                                                                           SELECT count(*) into total FROM EMPLOYEE;                                                                                                                    RETURN total;  END;                                                                                                                                                         $total$ LANGUAGE plpgsql;   

CREATE FUNCTION

**调用函数：**

select totalRecords(); 

totalrecords

42

(1 row)

**PostgreSQL事务处理：**

begin work;
BEGIN
insert into purchaseorder values(5007,'Unshipped',1001,current_date,'');  
INSERT 0 1
select * from purchaseorder;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/436f15572d44475c801698f0c5de1c47)

rollback; 
ROLLBACK

select * from purchaseorder;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/a2abc67e8b2dca5e4522fa49b6d4966a)

**退出PostgreSQL Shell：**

\q

