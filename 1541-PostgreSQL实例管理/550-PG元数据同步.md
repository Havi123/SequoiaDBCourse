**PostgreSQL元数据同步**

**课程介绍**

在两个或多个PostgreSQL实例之间，完成元数据（如：建外部表等DDL操作）的同步。

**创建一个新的PostgreSQL实例myinst1：**

cd /opt/sequoiasql/postgresql

bin/sdb_sql_ctl -D /opt/sequoiasql/postgresql/database/5433 addinst myinst1 -p 5433

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/cd64fbce31c461abf57dbcb218420028)

注：本环境中已存在PostgreSQL实例myinst，端口号：5432

**启动PostgreSQL实例myinst1：**

bin/sdb_sql_ctl start myinst1

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/239f019dd96c3336cdf3d226507c60c4)

**查看目前存在的两个PostgreSQL实例：**

bin/sdb_sql_ctl listinst

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/d3f6dc5710a386eb18ed0ef587e9064f)

**解压PostgreSQL元数据同步工具tar包：**

cd /home/sdbadmin

tar xvf SsqlDisseminateDDL.tar

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/381bcd6c3ad26bf0e360a5d7946e7ded)

**配置PostgreSQL免密登录，显示免密配置文件内容：**

cd SsqlDisseminateDDL

cp .pgpass /home/sdbadmin/

chmod 0600 /home/sdbadmin/.pgpass

more /home/sdbadmin/.pgpass

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/8c54db19e1ce0f8183c637c72cbf7388)

**进入myinst实例的PGDATA目录，拷贝准备好的postgresql.conf配置文件（备份原有postgresql.conf文件）**

cd /opt/sequoiasql/postgresql/database/5432

cp postgresql.conf postgresql.bak

cp /home/sdbadmin/SsqlDisseminateDDL/postgresql.conf ./

**显示新的postgresql.conf配置文件中与log日志相关的内容（其中部分参数已经过修改）：**

more postgresql.conf | grep "^\s*[^# \t].*$" |grep log

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/8aced686073b2baf79f3eb10eaed3e9b)

注：为了配合元数据同步，需要对应修改以下参数

log_destination = 'csvlog'
logging_collector = on
log_directory = '/opt/sequoiasql/postgresql/database/5432/pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 28d
log_rotation_size = 20MB
log_statement = 'ddl'

**将拷贝元数据同步程序及config配置文件拷贝到本地，显示config文件内容：**

cp /home/sdbadmin/SsqlDisseminateDDL/SsqlDisseminateDDL ./

cp /home/sdbadmin/SsqlDisseminateDDL/config ./ 

more config

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/3be507229c2b451fcff53a535421e039)

注：配置文件中参数包括：目标PostgreSQL实例myinst1运行的服务器名，端口号；源PostgreSQL实例myinst的安装目录，数据目录，解析日志目录；PostgreSQL同步用户；以及元数据同步程序的执行时间间隔、执行日志目录，执行日志文件前缀。

**创建配置文件指定的解析日志目录和执行日志目录，重启源PostgreSQL实例myinst：**

mkdir pg_log
mkdir log
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl restart myinst

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/21caba558c30032bf0a5c5313d95dff4)

**运行元数据同步程序：**

python SsqlDisseminateDDL &

[1] 1557

**验证元数据同步：**

**在PostgreSQL实例myinst中创建test数据库和表test：**

/opt/sequoiasql/postgresql/bin/sdb_sql_ctl createdb test myinst  
Creating database myinst ...
ok
psql -d test -p 5432
psql (9.3.4)
Type "help" for help.

create table test(id int,name char(10));
CREATE TABLE
\q

**在PostgreSQL实例myinst1中连接test数据库，访问表test：**

psql -d test -p 5433
psql (9.3.4)
Type "help" for help.

test=# select * from test;
 id | name 
----+------
(0 rows)

**通过创建样例数据库sample**

进入/opt/sequoiadb/samples目录，解压样例数据库samples.tar包：

cd /opt/sequoiadb/samples

tar xvf samples.tar

进入/opt/sequoiadb/samples/samples目录，运行sample_database.sh创建样例数据库sample，加载样例数据：

cd samples

./sample_database.sh

注：创建脚本将首先在SequoiaDB中创建集合空间sample及16个集合，并通过sdbimport加载样例数据。然后在缺省PosrgreSQL实例myinst中（5432端口）创建sample数据库，创建extension sdb_fdw，创建server sdb_server，最后，创建与SequoiaDB中16个集合相对应的16个外部表，实现对SequoiaDB的访问操作。

**在PostgreSQL的myinst1实例中，验证元数据同步，并访问SequoiaDB数据库**

psql -d sample -p 5433

**列出表信息**

\d

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/2348efcd75eb294f396dd464aef37a0c)                  

**访问样例表project:**

select * from project;

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/88e65b2acbe92c1b1ccfdaffa8f7416a)

注：通过上述操作，可以看出，在myinst实例中创建的sample数据库，以及与SequoiaDB的外表关联均已同步到myinst1实例中，且数据访问正常。

**退出PostgreSQL Shell：**

\q

