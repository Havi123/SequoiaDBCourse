
# PostgreSQL元数据同步

## 课程介绍

在两个或多个 PostgreSQL 实例之间，完成元数据（如：建外部表等DDL操作）的同步。该工具主要用于定时解析主SSQL的日志中新增的DDL操作语句并下发到各备SSQL执行，同时能过滤日志中执行失败的DDL操作语句。




#### 请点击右侧选择使用的实验环境

#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-PostgreSQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/ef825173c9cd86053b61306ca6df9c65)


详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-PostgreSQL 实例均为 3.4 版本。


## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库和 SequoiaSQL-PostgreSQL 实例的操作系统用户为 sdbadmin。
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本
```
sequoiadb --version
```
操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/b4082b0d6d6bdf89d229aa713a53759d)


## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/02fcaa58ac27e91688ead137fa748d6e)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤


## 创建 PostgreSQL 实例 myinst 和 myinst1

1）切换到 SequoiaSQL-PostgreSQL 安装目录；
```
cd /opt/sequoiasql/postgresql
```

2）添加实例；

添加实例 myinst（作为主 PostgreSQL 实例）

```
bin/sdb_sql_ctl addinst myinst -D database/5432/
```
添加实例 myinst1（作为备 PostgreSQL 实例）

```
bin/sdb_sql_ctl addinst myinst1 -D database/5433/
```

>Note:
>
> 指定实例名为myinst，该实例名映射相应的数据目录和日志路径，用户可以根据自己需要指定不同的实例名，实例默认端口号为5432。

3）查看实例，可以看到实例名为 myinst 的数据和日志目录信息；
```
bin/sdb_sql_ctl listinst
```

4）启动实例；

启动实例 myinst

```
bin/sdb_sql_ctl start myinst
```

启动实例 myinst1

```
bin/sdb_sql_ctl start myinst1
```

5）查看实例状态；

```
bin/sdb_sql_ctl status
```


## 配置 PostgreSQL 实例免密登录
若 PostgreSQL 实例开启了用户鉴权，需要创建元数据同步用户以及配置免密登录。

1）同步工具已提前放置在 sdbadmin 的 home 目录；

```
tar xvf SsqlDisseminateDDL.tar
```

3）进入解压目录
```
cd SsqlDisseminateDDL
```

4）拷贝免密文件到 home 目录
```
cp .pgpass /home/sdbadmin/
```

5）将文件权限设置为0600
```
chmod 0600 /home/sdbadmin/.pgpass
```

## PostgreSQL 实例日志设置

1）进入myinst实例的PGDATA目录，修改部分配置；
```
cd /opt/sequoiasql/postgresql/database/5432
```

2）使用vi 修改 postgresql.conf；

```
vi postgresql.conf
```
注：为了配合元数据同步，需要对应修改以下参数
```
log_destination = 'csvlog'
logging_collector = on
log_directory = '/opt/sequoiasql/postgresql/database/5432/pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 28d
log_rotation_size = 20MB
log_statement = 'ddl'
```

## 工具配置

将拷贝元数据同步程序及config配置文件拷贝到本地，显示config文件内容。

1）拷贝元数据同步工具到 home 目录；
```
cp /home/sdbadmin/SsqlDisseminateDDL/SsqlDisseminateDDL ./
```

2）拷贝元数据同步工具配置到 home 目录；
```
cp /home/sdbadmin/SsqlDisseminateDDL/config ./ 
```

3）查看config配置内容；
```
more config
```



操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1541/1207281/3be507229c2b451fcff53a535421e039)

注：配置文件中参数包括：目标 PostgreSQL 实例 myinst1 运行的服务器名，端口号；源 PostgreSQL 实例 myinst 的安装目录，数据目录，解析日志目录；PostgreSQL 同步用户；以及元数据同步程序的执行时间间隔、执行日志目录，执行日志文件前缀。




## 重启 myinst 实例，使配置生效
创建配置文件指定的解析日志目录和执行日志目录，重启源PostgreSQL实例myinst；

1）创建日志目录；
```
mkdir /opt/sequoiasql/postgresql/database/5432/pg_log
```

2）重启 myinst 实例；
```
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl restart myinst
```



## 配置系统定时任务

本操作的目的是利用操作系统的定时任务机制，定时检查程序是否在运行，若在运行则不操作，否则重新运行程序

```bash
crontab -e
# 在出现的编辑界面中输入以下内容
# 每一分钟运行一次
*/1 * * * * python  /home/sdbadmin/SsqlDisseminateDDL &
```

## 在 SequoiaDB 中建立集合空间和集合

1）使用 Linux 命令进入 SequoiaDB Shell 命令行

```
sdb
```

2）使用 JavaScript 语法，连接协调节点，获取数据库连接。

```javascript
var db = new Sdb ( "localhost", 11810 ) ;
```

2）创建 company_domain 逻辑域

```javascript
db.createDomain ( "company_domain", ["group1", "group2", "group3"], { AutoSplit : true } ) ;
```

3）创建 company 集合空间

```javascript
db.createCS ( "company", { Domain: "company_domain" } ) ;
```

4）创建 employee 集合

```javascript
db.company.createCL ( "employee", { "ShardingKey" : { "_id" : 1 } , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false } ) ;
```
5）写入数据；
```
db.company.employee.insert ( {empno :1 , ename : "Jack" , age : 35 } ) ;
```

6）退出 SequoiaDB Shell；
```
quit ;
```

## 验证元数据同步

#### 创建数据库
1）在 SequoiaSQL-PostgreSQL 实例中并创建 company 数据库实例，为接下来验证 MySQL 语法特性做准备。

以 sdbadmin 用户登录，在 PostgreSQL 实例创建数据库 company；
```
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl createdb company myinst
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/41b0823324fdd49a4c108c44bbf919df)

2）查看数据库；
```
/opt/sequoiasql/postgresql/bin/psql -l
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/03c2315513eaca111dcec04b1b1d2871)


#### 加载 SequoiaDB 连接驱动

1）登录 PostgreSQL Shell 连接 inst 实例 的 company 数据库；

```shell
/opt/sequoiasql/postgresql/bin/psql -p 5432 company
```

2）加载SequoiaDB连接驱动；
```sql
CREATE EXTENSION sdb_fdw ;
```

3）配置与 SequoiaDB 连接参数
在 PostgreSQL 实例中配置 SequoiaDB 连接参数：
```sql
CREATE SERVER sdb_server FOREIGN DATA WRAPPER sdb_fdw 
    OPTIONS (address '127.0.0.1', service '11810', user '', password '', preferedinstance 'A', transaction 'on' ) ;
```

4）实例与数据引擎中集合关联
将 PostgreSQL 实例中的外部表并与 SequoiaDB 中的集合空间、集合关联。

```sql
CREATE FOREIGN TABLE employee (
     empno INT,
     ename VARCHAR(128),
     age INT
  ) 
  SERVER sdb_server
  OPTIONS ( collectionspace 'company', collection 'employee', decimal 'on' ) ;
```

5）查询 myinst 实例 employee 表中的数据；

```sql
SELECT * FROM employee ;
```

6）退出 myinst1 实例；
```sql
\q
```
## 查询 myinst1 实例是否已经建表成功

1）登录 PostgreSQL Shell 连接 inst1 实例 的 company 数据库；
```
/opt/sequoiasql/postgresql/bin/psql -p 5433 company
```

2）查询 myinst 实例 employee 表中的数据；

```sql
SELECT * FROM employee ;
```


## 总结
本课程讲述了 SequoiaSQL-PostgreSQL 的元数据同步工具的部署和使用，并进行了创建数据库和外表表的测试。


