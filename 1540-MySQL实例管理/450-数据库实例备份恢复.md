
---
show: step
version: 1.0
enable_checker: true
---

# 数据库实例备份恢复



## 课程介绍
本课程主要讲解 MySQL 的数据库实例备份恢复操作。

#### 请点击右侧选择使用的实验环境

#### mysqldump 工具介绍
mysqldump 是 MySQL 自带的逻辑备份工具。它的备份原理是，通过协议连接到 MySQL 数据库，将需要备份的数据查询出来，将查询出的数据转换成对应的 insert 语句，当我们需要还原这些数据时，只要执行这些 insert 语句，即可将对应的数据还原。
mysqldump 的优点是简单灵活，备份空间小，数据格式清晰，方便编辑，可以进行不同级别备份，全局、单库、单表；可以进行一致性备份，适用于轻量级规模的场景。
mysqldump的缺点是备份的过程是串行化的，不会并行的进行备份，所以速度较慢，如果想要并行备份，可以使用mydumper。

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。


## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库和 SequoiaSQL-MySQL 实例的操作系统用户为 sdbadmin。
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本
```
sequoiadb --version
```
操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/03eb5c621476f2788a52a6ea755b23bd)

#### 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图:  
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/cdc72e13c0eb5bedfbeb94c800c94f36)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤

#### 检查 MySQL 实例进程

查看 MySQL 数据库实例
```
/opt/sequoiasql/mysql/bin/sdb_sql_ctl listinst
```

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/92856e2e05fee65495cb876332cd34c6)

查看数据库实例进程
```
ps -elf | grep mysql
```

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/41b259ef9f2b7f16466b3d89606998c4)



## 备份

#### 备份单库几个表

mysqldump 工具按表导出 /tmp/employee_import_test.sql
```
/opt/sequoiasql/mysql/bin/mysqldump -h 127.0.0.1 -u root -proot  company employee_import_test > /tmp/employee_import_test.sql
```
> **注意**:  
> mysqldump 导出的是 sql 执行语句， 包含数据。其中导出的命令包含以下示例命令：
```shell
# 备份所有库:
mysqldump -h 127.0.0.1 -u root -proot  -A > /tmp/employee_import_test.sql
# 备份单个库所有表:
mysqldump -h 127.0.0.1 -u root -proot  -B 库名> /tmp/employee_import_test.sql
# 备份单个库单个表:
mysqldump -h 127.0.0.1 -u root -proot  库名 表名> /tmp/employee_import_test.sql
# 备份单个库某几个表:
mysqldump -h 127.0.0.1 -u root -proot  库名 表名 表名> /tmp/employee_import_test.sql
```

数据检查
```
cat /tmp/employee_import_test.sql
```

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/8067899cacdbb5c9b0b3487ba970de85)

> **注意:**  
> 因为内容较多， 仅截了图中的部分内容

#### 备份单库单表
备份单个库单个表
```
mysqldump -h 127.0.0.1 -u root -proot  库名 表名> /home/sdbadmin/mysqlbak/test.sql
```

#### 备份单个库
备份单个库所有表
```
mysqldump -h 127.0.0.1 -u root -proot  -B 库名> /home/sdbadmin/mysqlbak/test.sql
```

#### 备份所有库
备份所有库
```
mysqldump -h 127.0.0.1 -u root -proot  -A > /home/sdbadmin/mysqlbak/test.sql
```


## 恢复

#### 登录到 MySQL 实例
登录 MySQL 实例
```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root -p
```

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/b667a6cc7f74c4b19d832efe32054996)

#### mysqldump 恢复

mysqldump 导出后生成的文件是sql语句的集合，可以直接执行。
```sql
SOURCE /tmp/employee_import_test.sql;
```

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/edf9df0f650cb413beb0b57f72122b94)

> **注意:**  
> 因为输出较多， 只截了部分图


#### mysqldump 工具恢复检查

mysqldump 导出后生成的文件是sql语句的集合，可以直接执行。
```sql
USE company ;
SELECT * FROM employee_import_test ; 
```
> **注意:**  
> 因为我们导出的是数据表， 所以导入的时候， 需要选择好相应的数据库

操作截图:
![图片描述](https://doc.shiyanlou.com/courses/1540/1207281/1f6ffbdfddd92debb6eaf42cfba6f62d)



