---
show: step
version: 1.0 
---


## 挑战 MySQL 数据迁移和备份

#### 介绍

在实际的生产环境中，因为业务发展的需要，数据库的数据往往需要进行迁移到其它的库进行存储。同时本地的库也需要进行数据的备份等操作。

#### 目标

1）创建 MySQL 高可用实例 ;  
2）使用存储过程构造1000条数据 ;  
3）对数据存储的表进行 CSV 格式迁移 ;  
4）对数据进行备份 ;  

#### 提示

1）使用垂直分区、水平分区存储数据；  
2）现在 SequoiaDB 中创建集合，然后在 MySQL 实例中映射创建的集合；  
3）MySQL的实例需要是高可用 ；  

#### 参考答案

1）主表使用时间字段分区，子表使用主键分区，如主表分区字段createtime，子表分区字段logid；
2）MySQL 实例中映射表有主键字段；
3）迁移操作命令：
```shell
# csv 导出
SELECT * FROM employee   
INTO OUTFILE '/tmp/employee_export.csv'   
FIELDS TERMINATED BY ','
OPTIONALLY ENCLOSED BY '"'
ESCAPED BY '"'
LINES TERMINATED BY '\r\n';

# csv 导入
LOAD DATA INFILE '/tmp/employee_export.csv'
INTO TABLE employee_import_test
FIELDS TERMINATED BY ','
OPTIONALLY ENCLOSED BY '"'
ESCAPED BY '"'
LINES TERMINATED BY '\r\n'; 
```
4）备份操作命令
```
/opt/sequoiasql/mysql/bin/mysqldump -h 127.0.0.1 -u root -proot  company employee_import_test > /tmp/employee_import_test.sql
```


## 挑战 MySQL 实例的性能分析

#### 介绍

MySQL 在实际生产环境中，会因为各种情况而导致数据库的查询比较慢。在碰到这种场景的时候，开发运维人员往往需要对现在的 SQL 语句和情况进行分析， 最后完成性能的调优工作。

#### 目标

1）创建的数据和表可以基于“挑战 MySQL 数据迁移和备份” 这一节的内容  
2）对 MySQL 进行慢查询日志配置 ；
3）在 SQL 中使用 sleep 语法构造慢查询场景(SQL 未创建索引导致), 生成慢查询日志 ；
4）使用 EXPLAIN 进行分析；
5）根据 EXPLAIN 分析的结果进行优化；  

#### 提示

1）使用垂直分区、水平分区存储数据；  
2）现在 SequoiaDB 中创建集合，然后在 MySQL 实例中映射创建的集合；  
3）MySQL的实例需要是高可用 ；  
4）因为数据量及环境的原因，比较难构造慢查询的SQL，可以采用 sleep 语法构造一个因为未创建索引而导致慢查询的场景；

#### 参考答案

1）主表使用时间字段分区，子表使用主键分区，参考《挑战 MySQL 数据迁移和备份》；
2）存储过程构建数据语句参考；
```sql
DROP PROCEDURE IF EXISTS gen_data;
USE company ;
-- 创建存储过程
DELIMITER $$

CREATE PROCEDURE gen_data(IN num INT)
BEGIN
DECLARE i INT DEFAULT 0 ;
SET i = 0 ;
WHILE i < num DO

INSERT INTO employee_analyze_test VALUES (i, i, '2020-01-01', 'NewYear-NewDay', 'NewLife', 'M', '2020-01-01') ;

SET i = i + 1 ;
END WHILE ;
END $$
DELIMITER ;

-- 调用存储过程生成 1000 条数据
CALL gen_data(1000) ;

```
3）EXPLAIN 和创建索引；
```sql
-- EXPLAIN
EXPLAIN SELECT emp_no, emp_seq, first_name,last_name FROM employee_analyze_test WHERE emp_seq = 20;

-- CREATE INDEX
CREATE INDEX emp_seq_idx ON employee_analyze_test (emp_seq) ;
```
