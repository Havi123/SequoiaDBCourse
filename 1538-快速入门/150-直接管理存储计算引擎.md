---
show: step
version: 1.0
enable_checker: true
---

# 直接管理存储计算引擎

## 课程介绍

本课程介绍如何管理存储计算引擎，包含执行管理操作、运行实例检查、数据增删改查等操作。

#### 请点击右侧选择使用的实验环境

#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-MySQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/8d88e6faed223a26fcdc66fa2ef8d3c5)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。

## 切换用户

部署 SequoiaDB 巨杉数据库和 SequoiaSQL-MySQL 实例的操作系统用户为 sdbadmin。

1）切换至 sdbadmin 用户；
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

## 集群节点启停

1）检查本机上 SequoiaDB 节点启动情况
```
sdblist -l
```

2）停止本机上所有 SequoiaDB 节点
```
sdbstop -t all
```

3）启动本机上所有 SequoiaDB 节点
```
sdbstart -t all
```

4）查看本机上的 MySQL 实例
```
/opt/sequoiasql/mysql/bin/sdb_sql_ctl listinst
```

5）检查本机上的 MySQL 实例，实例名为"myinst", 存在进程号(PID)表示 MySQL 实例正在运行
```
/opt/sequoiasql/mysql/bin/sdb_sql_ctl status myinst
```

操作截图：

![](https://doc.shiyanlou.com/courses/1538/1207281/c368a733c493f21f15d365bda8edea13)

## 集群管理操作

1）在 Linux 命令行中进入 SequoiaDB Shell 交互式界面；

```
sdb
```

2）使用 JavaScript 连接协调节点，并获取数据库连接；

```javascript
var db = new Sdb ( "localhost", 11810 ) ;
```

3）查看集群拓扑结构
```
db.list ( SDB_LIST_GROUPS ) ;
```

操作截图：

![](https://doc.shiyanlou.com/courses/1538/1207281/d391347a5d499ae39ff3a681f0d3b58c)

4) 检查集群节点状态，集群有异常节点时，在"ErrNodes"字段中列出
```
db.snapshot ( SDB_SNAP_DATABASE ) ;
```

操作截图：

![](https://doc.shiyanlou.com/courses/1538/1207281/0dda8edb8f7247ff2670c65405c2f595)

## 创建集合空间和集合

1）创建 company_domain 逻辑域

```javascript
db.createDomain ( "company_domain", ["group1", "group2", "group3"], { AutoSplit : true }) ;
```

2）创建 company 集合空间

```javascript
db.createCS ( "company", { "Domain" : "company_domain" }) ;
```

3）创建 employee 集合 

```javascript
db.company.createCL ( "employee", { "ShardingKey" : { "_id" : 1 }, "ShardingType" : "hash" }) ;
```
## 巨杉数据库存储引擎的 CRUD 操作

用户可以直接使用 SequoiaDB Shell 提供的交互式 JavaScript 接口进行数据的插入、查询、更新与删除操作。

1）使用 insert() 向 SequoiaDB 巨杉数据库集合中写入记录；


```javascript
db.company.employee.insert ({ empno : 1 , ename : "Jacky", age : 28 , department : 'Sales Department' }) ;
db.company.employee.insert ({ empno : 2 , ename : "Abe", age : 36 , department : 'Sales Department' }) ;
db.company.employee.insert ({ empno : 3 , ename : "Alice", age : 23 , department : 'Personnel Department' }) ;
db.company.employee.insert ({ empno : 4 , ename : "Jane", age : 25 , department : 'Personnel Department' }) ;
```


2）使用 find() 方法从集合中查询数据记录；

```javascript
db.company.employee.find ({ ename: "Abe" }) ;
```

3）使用 update() 方法将集合中的记录进行修改；

```javascript
db.company.employee.update ({ $set : { age : 29 } } , { empno : 1 }) ;
```

4）使用 remove() 方法从集合中删除数据；

```javascript
db.company.employee.remove ({ ename : "Alice" }) ;
```

## 巨杉数据库存储引擎的数据聚集操作

聚集框架提供了对集合中的原始数据记录进行统计计算的能力。通过使用聚集框架，用户能够直接从集合中提取数据记录并获取所需的统计结果。

详细了解 SequoiaDB 巨杉数据库聚集说明和使用方法：
* [SequoiaDB 聚集框架](http://doc.sequoiadb.com/cn/index-cat_id-1432190614-edition_id-304)




1）统计集合 employee 中不同部门的平均年龄

```javascript
db.company.employee.aggregate ({ "$group" : { "_id" : "$department", "avg_age" : { "$avg" : "$age" }, "department" : "$department" }}) ;
```

2）关闭 db数据库连接；

```javascript
db.close () ;
```

3）退出 SequoiaDB Shell；

```
quit ;
```

## 总结
SequoiaDB 在存储计算引擎均提供接口可以执行管理操作、运行实例检查、数据增删改查等操作。
