---
show: step
version: 1.0
enable_checker: true
---

# 数据库事务管理

## 课程介绍

本课程介绍了如何使用数据库的事务功能。

#### 请点击右侧选择使用的实验环境


#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/dd11cb78ba9732f36f58883df952282a)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。

## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库的操作系统用户为 sdbadmin。
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本

```
sequoiadb --version
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/1d1b4057ef81bc03b825926d3071183a)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/3ebdc835c21b5685d858918d25a9f372)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤

## 创建域、集合空间、集合

1）通过 Linux 命令行进入 SequoiaDB Shell；

```
sdb
```

2）通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

3）创建 company_domain 逻辑域；

```javascript
db.createDomain ("company_domain", ["group1", "group2", "group3"], { AutoSplit : true }) ;
```

4）创建 company 集合空间；

```javascript
db.createCS ("company", { Domain : "company_domain" }) ;
```

5）创建 employee 集合；

```javascript
db.company.createCL ("employee", {"ShardingKey" : { "_id" : 1} , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false }) ;
```

6）退出 SequoiaDB Shell；
```
quit ;
```



## 巨杉数据库存储引擎事务操作
除了可以在 SequoiaSQL-MySQL 数据库实例中进行事务控制外，SequoiaDB 巨杉数据库存储引擎也支持完整的事务功能：
* [SequoiaDB 巨杉数据库事务说明](http://doc.sequoiadb.com/cn/index-cat_id-1432190590-edition_id-304)

#### 事务提交操作
1）开始事务；

```javascript
db.transBegin () ;
```

2）写入数据；

```javascript
db.company.manager.insert ({ empno : 1 , department : "Personnel Department" }) ;
```

3）提交事务；

```javascript
db.transCommit () ;
```

4）查询写入数据；

```javascript
db.company.manager.find ({ empno : 1 }) ;
```

#### 事务回滚操作
除了可以在 SequoiaSQL-MySQL 数据库实例中进行事务控制外，SequoiaDB 巨杉数据库存储引擎也支持完整的事务功能：

1）开始事务；

```javascript
db.transBegin () ;
```

2）写入数据；

```javascript
db.company.manager.insert ({ empno : 2 , department : "Sales Department" }) ;
```

3）提交事务；

```javascript
db.transRollback () ;
```

4）查询写入数据；

```javascript
db.company.manager.find ({ empno : 2 }) ;
```
查询返回0条记录，说明 empno 为2的记录已经回滚。

 
## 总结

SequoiaDB 巨杉数据库是一个分布式数据库，可以存储海量的结构化和非结构化数据，并提供多种接口实例，以方便应用程序的访问。事务是保证数据一致性的关键功能，SequoiaDB 支持事务功能。本课程简单介绍了如何使用数据库的事务功能，包括：打开事务，提交事务，回滚事务。

