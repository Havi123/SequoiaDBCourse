---
show: step
version: 1.0 
---

## 挑战 完成集群的备份恢复操作

#### 介绍
在生产环境中，出于对数据安全方面更严格的考虑，希望能够对整个数据库进行定期的数据备份，以便在未来系统出现异常时，能够在灾难环境中进行数据恢复。

管理员在对SequoiaDB集群做数据备份和恢复工作时，应该要时刻注意分布式数据库与关系型数据库的不同，即数据备份和恢复都会涉及到多台服务器的数据库服务，而不只是在某一台服务器上做相应的操作。

#### 目标
1) 创建集合空间和集合并导入一些记录
2) 全量备份
3) 再次插入一些新记录
4) 增量备份
5) 删除集合空间
6) 全量恢复并检查
7) 增量恢复并检查
8) 删除测试数据并退出

#### 提示
1) 备份时需要指定备份目录，否则会备份到默认路径下
2) 增量备份的备份名应和上一次全量备份保持一致
3) 恢复时需要停止集群，恢复完毕后再启动

#### 参考答案
1) 创建集合空间和集合并导入一些记录
```
su - sdbadmin
sdb
db = new Sdb
db.createCS("foo")
db.foo.createCL( "bar",{ ShardingKey:{ id: 1 }, ShardingType: "hash", Partition: 4096, ReplSize: 1 } )
db.foo.bar.insert([{id:1,name:"aa"},{id:2,name:"bbb"},{id:3,name:"cccc"},{id:4,name:"ddddd"},{id:5,name:"eeeeee"},{id:6,name:"fffffff"}])
```

2) 全量备份
```
db.backup({Name:"fullback",Path:"/tmp/%g",Overwrite:true,Description:"full backup"})
```

3) 再次插入一些新记录
```
db.foo.bar.insert([{id:7,name:"x"},{id:8,name:"y"},{id:9,name:"z"}])
```

4) 增量备份
```
db.backup({Name:"fullback",Path:"/tmp/%g",EnsureInc:true})
```

5) 删除集合空间
```
db.dropCS("foo")
quit
```

6) 全量恢复并检查
```
mv /tmp/group3/full.back.2 /tmp
mv /tmp/group3/full.back.bak.1 /tmp
sdbstop --all
sdbrestore -p /tmp/SYSCatalogGroup/ -n fullback -b 0
sdbrestore -p /tmp/group1/ -n fullback -b 0
sdbrestore -p /tmp/group2/ -n fullback -b 0
sdbrestore -p /tmp/group3/ -n fullback -b 0
sdbstart
sdb
db = new Sdb
db.foo.bar.find({},{id:null})
quit
```

7) 增量恢复并检查
```
sdbstop --all
sdbrestore -p /tmp/group3/ -n fullback -b 1
sdbstart
sdb
db = new Sdb
db.foo.bar.find({},{id:null})
```

8) 删除测试数据并退出
```
db.dropCS("foo")
quit
```
