---
show: step
version: 1.0
enable_checker: true
---

# 存储引擎上的数据操作

## 课程介绍


本课程介绍了如何创建集合空间与集合，修改集合空间配置参数，以及在集合上进行增删改查操作。

#### 请点击右侧选择使用的实验环境

#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-MySQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/8d88e6faed223a26fcdc66fa2ef8d3c5)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。



## 检查集群以及数据库实例是否已启动
```
su - sdbadmin
sdblist -l -m local
/opt/sequoiasql/mysql/bin/sdb_sql_ctl listinst
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl listinst
```

操作截图：
![检查集群以及数据库实例是否已启动](https://doc.shiyanlou.com/courses/1480/1207281/43fa875113512dce1537a215042f7c38)


## 创建集合空间，修改配置参数，创建集合
1) 打开数据库连接
```
su - sdbadmin
sdb
db = new Sdb
```

>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

2) 使用默认配置创建集合空间,然后修改pagesize参数为8192
```
db.createCS("foo")
db.foo.alter({PageSize:8192})
```

3) 在刚创建的集合空间中创建一个集合
```
db.foo.createCL("bar")
```

4) 通过 snapshot 函数检查修改是否生效(创建集合后才能抓取到集合空间的快照)
```
db.snapshot(5,{},{Name:null,PageSize:null})
```

5) 通过 listCollections 函数检查集合是否存在
```
db.listCollections()
```
操作截图：
![创建集合空间和集合](https://doc.shiyanlou.com/courses/1480/1207281/ea28c66dce3ac7e76406d6a83a62770e)



## 集合上的插入操作
在 SequoiaDB 中，insert 操作是向集合中添加新的文档记录。我们可以使用insert() 方法向 SequoiaDB 中的集合中添加记录。

所有的插入操作在 SequoiaDB 中具有如下性质：
（1）如果插入的文档记录没有 _id 字段，客户端将会为记录自动添加 _id 字段，并且填充一个唯一值。
（2）如果指定 _id 字段，那么在集合中 _id 的值必须唯一；否则出现操作异常。
（3）最大的 BSON 文档长度为16MB。
（4）文档结构的字段命名有如下限制：字段名 _id作为主键保存在集合中，它的值必须唯一且不可改变，它的值可以是除数组类型以外的其他任何类型。字段的命名不能是空串；不能以$开始；不能含有（.）。

在集合中插入部分记录
```
db.foo.bar.insert({id:1,name:"aa"})
db.foo.bar.insert({id:2,name:"bbb"})
db.foo.bar.insert({id:3,name:"cccc"})
db.foo.bar.insert({id:4,name:"ddddd"})
db.foo.bar.insert({id:5,name:"eeeeee"})
```

操作截图：
![插入操作](https://doc.shiyanlou.com/courses/1480/1207281/07ee145f8ae18b2ce2f26d0ec9f8dc30)

## 集合上的删除操作
remove() 方法是删除集合中记录主要方法。

在集合中删除部分记录并查询
```
db.foo.bar.remove( { id:5 } )
db.foo.bar.find()
```

操作截图：
![删除操作](https://doc.shiyanlou.com/courses/1480/1207281/0776f215636367c36ffbb4c3cfcc2c0b)

## 集合上的更新操作
如果 update() 方法只有 rule 参数时（例如使用 $set 更新表达式），那么 update 方法会修改集合记录中所有指定的字段；更新嵌套对象 SequoiaDB 使用点操作符（.）。

在集合中更新部分记录并查询
```
db.foo.bar.update({$set:{name:"ff"}},{id:1})
db.foo.bar.find()
```

操作截图：
![更新操作](https://doc.shiyanlou.com/courses/1480/1207281/c0505a2da96aae8201589ff6f72cc425)

## 集合上的查询操作
find() 方法是查询集合中记录的主要方法。

带条件查询集合中的部分记录
```
db.foo.bar.find({id:3})
```

操作截图：
![条件查询](https://doc.shiyanlou.com/courses/1480/1207281/d392b0d8a318f26bd76ed640ff97cc96)

## 删除测试数据，退出连接
```
db.dropCS("foo")
quit
```

## 总结

Sequoiadb是一个分布式数据库，可以存储海量的结构化和非结构化数据，并提供多种接口实例，以方便应用程序的访问。本课程简单介绍了如何创建集合空间与集合，修改集合空间配置参数，以及在集合上进行增删改查操作。

关于增删改查操作的更多详细信息，请参考官网：
* [集合的增删改查操作](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190609-edition_id-304)
