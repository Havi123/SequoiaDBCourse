---
show: step
version: 1.0
enable_checker: true
---

# 备份恢复

## 课程介绍

本课程介绍了如何实现巨杉数据库集群的备份恢复操作。

在大数据时代，由于数据库需要存储的数据量比较过去关系型数据库要大很多，所以直接参照关系型数据库定期备份文件的策略，可能在备份和恢复操作上都需要耗费大量的硬件资源，并且备份和恢复耗时可能也会相对较长。所以在大数据时代，分布式数据库的安全备份的策略不再建议采用定期备份的方式，而是直接由数据库通过数据冗余的方式来保证数据的安全。

数据冗余的机制即是当应用程序向数据库中写入或者更新一条新记录时，数据库自动将此新操作实时同步到多台物理服务器中，确保多台服务器同时保存相同的数据，从而实现数据库的高可用机制。但是在一些客户的生产环境中，客户出于对数据安全方面更严格的考虑，还是希望能够对整个数据库进行定期的数据备份，以便在未来系统出现异常时，能够在灾难环境中进行数据恢复。

管理员在对SequoiaDB集群做数据备份和恢复工作时，应该要时刻注意分布式数据库与关系型数据库的不同，即数据备份和恢复都会涉及到多台服务器的数据库服务，而不只是在某一台服务器上做相应的操作。

#### 请点击右侧选择使用的实验环境

#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/dd11cb78ba9732f36f58883df952282a)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。

## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库的操作系统用户为 sdbadmin。
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本

```
sequoiadb --version
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/1d1b4057ef81bc03b825926d3071183a)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1543/1207281/3ebdc835c21b5685d858918d25a9f372)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤


## 准备测试数据

1）通过 Linux 命令行进入 SequoiaDB Shell；

```
sdb
```

2）通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

3）创建 company_domain 逻辑域；

```javascript
db.createDomain ("company_domain", ["group1", "group2", "group3"], { AutoSplit : true }) ;
```

4）创建 company 集合空间；

```javascript
db.createCS ("company", { Domain : "company_domain" }) ;
```

5）创建 employee 集合；

```javascript
db.company.createCL ("employee", {"ShardingKey" : { "_id" : 1} , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false }) ;
```

## 写入测试数据

本小节使用 JavaScript 的 for 循环向 employee 表写入1000条记录，用于测试。

```javascript
for (var i = 0 ; i < 1000 ; i++) { db.company.employee.insert ({ empno：i , ename : "TEST", age : 20 }) }
```


## 全量备份与增量备份

当前版本中，数据库备份支持全量备份和增量备份。全量备份过程中会阻塞数据库变更操作，即数据插入、更新、删除等变更操作会被阻塞直到全量备份完成才会执行；增量备份过程中不阻塞数据库变更操作。

全量备份：备份整个数据库的配置、数据和日志（可选）；

增量备份：在上一个全量备份或增量备份的基础上备份新增的日志和配置；增量备份需要保证日志的连续性和一致性，如果日志不连续，或日志Hash校验不一致，则增量备份失败。因此，周期性的增量备份需要计算好日志和周期的关系，以防止日志覆写。

在协调节点上对整个数据库或指定组进行备份，默认是只在该数据组主节点上进行备份。Catalog 编目组的名称固定为 SYSCatalogGroup

使用 Sdb.backup() 命令可以进行备份。具体参数说明参考
* [数据备份](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190664-edition_id-0)


#### 全量备份
1) 执行集群全量备份命令
```
db.backup({Name:"fullback",Path:"/tmp/%g",Overwrite:true,Description:"full backup"})
```

2）退出 SequoiaDB Shell；
```
quit ;
```

3）检查备份文件是否生成
```
ls /tmp
ls /tmp/group1/
ls /tmp/group2/
ls /tmp/group3/
```

操作截图：
![全量备份](https://doc.shiyanlou.com/courses/1480/1207281/d6d3818f8c173194d499706d33419188)

可以看到，在/tmp目录下有4个文件夹，SYSCatalogGroup，group1,group2,group3，分别对应编目节点，数据组1，数据组2，数据组3。



#### 增量备份
1）通过 Linux 命令行进入 SequoiaDB Shell；

```
sdb
```

2）通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

3)写入增量数据；
```javascript
for (var i = 1000 ; i < 2000 ; i++) { db.company.employee.insert ({ empno：i , ename : "TEST", age : 20 }) } ;
```

4）执行增量备份；
```
db.backup({Name:"fullback",Path:"/tmp/%g",EnsureInc:true}) ;
```

5）查看备份信息；
```
db.listBackup({Path:"/tmp"})
```

操作截图：

![查看备份信息](https://doc.shiyanlou.com/courses/1480/1207281/d6fc73d7631e4bd2b31eb2ec22cb5523)

6）退出 SequoiaDB Shell；
```
quit ;
```

7）检查备份文件是否生成
```
ls /tmp/group1/
ls /tmp/group2/
ls /tmp/group3/
```

>Note:
>
>增量备份的备份名应和上一次全量备份保持一致


操作截图：
![增量备份](https://doc.shiyanlou.com/courses/1480/1207281/5dd86eba2984f33effb1e3bbfd8798a9)

可以看到，相比于全量备份生成的文件，增量备份在/tmp/group3目录下新生成了两个文件，表示第二次插入的记录都在group3这个分区组上。



## 全量恢复与增量恢复
使用备份的数据恢复当前集群中的节点 或者 恢复到离线数据。 

恢复当前集群中的节点：执行数据恢复必须确保该节点对应的数据组已停止运行，数据恢复首先会清空原节点的所有数据和日志，然后从备份的数据中恢复配置、数据和日志。

恢复到离线数据：可以将全量备份和增量备份的数据不断合并成一份与节点内数据完全相同格式的离线数据，可以在原节点故障后使用该离线数据实现快速恢复。

如果一个分区组包含多个数据节点，必须停止该组中每个数据节点并进行恢复。如果将备份的数据恢复至非备份数据节点，需要把 --isSelf 设置成 false，同时设置相关的配置参数。

恢复分区组其他节点数据，恢复方式有以下几种：

1）删除该分区组中其它数据节点的所有.data 和 .idx 、.lobd、.lobm文件以及replicalog 日志，节点启动后会自行同步数据。 

2）拷贝恢复节点的所有 .data 和 .idx 、.lobd、.lobm文件拷贝至其它数据节点的数据目录和索引目录下，以及将该节点的所有 replicalog 日志拷贝至其它数据节点的 replicalog 日志目录下。

3）将备份文件拷贝至其它数据节点，并通过 sdbrestore 工具恢复。

使用 sdbrestore 可以进行数据恢复，具体参数说明参考下面这个链接：http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190666-edition_id-0

#### 全量恢复

1）通过 Linux 命令行进入 SequoiaDB Shell；

```
sdb
```

2）通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

3）删除集群上的集合空间；

```
db.dropCS("company")
```

4）退出 SequoiaDB Shell；
```
quit ;
```

5）停止所有节点；

```
sdbstop -t all
```

6）执行全量恢复操作；
```
mv /tmp/group3/full.back.2 /tmp
mv /tmp/group3/full.back.bak.1 /tmp
sdbstop --all
sdbrestore -p /tmp/SYSCatalogGroup/ -n fullback -b 0
sdbrestore -p /tmp/group1/ -n fullback -b 0
sdbrestore -p /tmp/group2/ -n fullback -b 0
sdbrestore -p /tmp/group3/ -n fullback -b 0
sdbstart
```


7）启动节点；
```
sdbstart -r cata;
sdbstart -r coord;
sdbstart -r data;
```


>Note:
>
>执行全量恢复时要先停节点，恢复完后再启动，为了方便，将整个集群停下来
>恢复的时候需要按节点恢复，分别是编目节点，数据组1，数据组2，数据组3
>由于group3下还有增量备份的文件，恢复的时候会将目录下所有的文件都恢复上去，因此只测全量备份需要将增量备份的文件移走

操作截图：

![全量恢复1](https://doc.shiyanlou.com/courses/1480/1207281/0406bb48797de21ccf4ece9e088716ed)

![全量恢复2](https://doc.shiyanlou.com/courses/1480/1207281/8045843a15ea7b7d7153480490c7deda)

![全量恢复3](https://doc.shiyanlou.com/courses/1480/1207281/1aa4268552e76e80a4132b00f05061da)


8）检查数据是否正确，此时只能查到集合中的第一次插入的数据；

通过 Linux 命令行进入 SequoiaDB Shell；

```
sdb
```

通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

统计 company.employee 数据量；
```
db.company.employee.count () ;
```

退出 SequoiaDB Shell；

```
quit ;
```

操作截图：
![全量恢复后检查](https://doc.shiyanlou.com/courses/1480/1207281/79aacfc09048dce85420ced0ecf0b407)

此时只能看到第一次插入的6条记录，第二次插入的3条记录看不到。

#### 增量恢复

1）停止所有节点；

```
sdbstop -t all
```


2）增量恢复操作；
```
sdbrestore -p /tmp/group3/ -n fullback -b -1
```

>Note:
>
>注意 -b 后面带的参数，代表需要从第几次备份开始恢复，缺省由系统自动计算 ( -1 )。

3）启动节点；
```
sdbstart -r cata;
sdbstart -r coord;
sdbstart -r data;
```


操作截图：
![增量恢复](https://doc.shiyanlou.com/courses/1480/1207281/0ac2519c30e4225b25db5776b28e8fbe)


4）检查数据是否正确，此时能看到第二次插入的记录；
通过 Linux 命令行进入 SequoiaDB Shell；

```
sdb
```

通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

统计 company.employee 数据量；
```
db.company.employee.count () ;
```

退出 SequoiaDB Shell；

```
quit ;
```

操作截图：
![增量恢复后检查](https://doc.shiyanlou.com/courses/1480/1207281/14cb05f046bb7e15ec5765c410c286fc)




## 总结

SequoiaDB 巨杉数据库是一个分布式数据库，可以存储海量的结构化和非结构化数据，并提供多种接口实例，以方便应用程序的访问。本课程简单介绍了如何在sdb上实现全量备份，增量备份，全量恢复和增量恢复。

有关备份恢复的详细介绍，请参考
* [备份恢复详细介绍](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190664-edition_id-0)
