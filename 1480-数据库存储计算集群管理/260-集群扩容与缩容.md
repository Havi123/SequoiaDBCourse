---
show: step
version: 1.0 
---

# 快速创建集群

## 课程介绍

本课程介绍了如何完成巨杉数据库集群的扩容和缩容操作。

SequoiaDB（巨杉数据库，简称Sdb,下同）是一款金融级别的分布式数据库，可以通过集群的扩容实现集群性能的近线性增长。通过扩容后主要解决两个问题：数据存储的容量问题和整个集群的性能问题。因为数据量的不断增长及上线后的推广使用，所以需要进行扩容来提升集群性能及增加数据存储空间。
当集群中的部分服务器使用年限过长，即将淘汰时，此时需要进行集群的缩容操作，将数据从旧服务器移走，然后将旧的服务器移出集群。

#### 请点击右侧选择使用的实验环境

#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-MySQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/8d88e6faed223a26fcdc66fa2ef8d3c5)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。

## 检查集群以及数据库实例是否已启动
```
su - sdbadmin
sdblist -l -m local
/opt/sequoiasql/mysql/bin/sdb_sql_ctl listinst
/opt/sequoiasql/postgresql/bin/sdb_sql_ctl listinst
```

操作截图：
![检查集群以及数据库实例是否已启动](https://doc.shiyanlou.com/courses/1480/1207281/43fa875113512dce1537a215042f7c38)e


## 集群扩容
1) 创建数据域1，对应现有数据组和数据节点
```
sdb
db = new Sdb
db.createDomain( 'dom1', ['group1', 'group2','group3'], { AutoSplit: true } )
```


2) 在数据域1上创建集合空间和集合，并初始化一些记录
```
db.createCS("foo",{Domain:"dom1"})
db.foo.createCL( "bar",{ ShardingKey:{ id: 1 }, ShardingType: "hash", Partition: 4096, ReplSize: 1 } )
db.foo.bar.insert([{id:1},{id:2 },{id:3 },{id:4 },{id:5 },{id:6 },{id:7 },{id:8 },{id:9 },{id:10},{id:11},{id:12},{id:13},{id:14},{id:15},{id:16},{id:17},{id:18},{id:19},{id:20},{id:21},{id:22},{id:23},{id:24},{id:25},{id:26},{id:27},{id:28},{id:29},{id:30}])
```

操作截图：
![扩容初始化](https://doc.shiyanlou.com/courses/1480/1207281/7d4fb57ef1b2e61308bd81d9e8fe4a92)

3) 登录各个数据节点检查一下记录数
```
db = new Sdb("localhost",11820)
db.foo.bar.count()
db = new Sdb("localhost",11830)
db.foo.bar.count()
db = new Sdb("localhost",11840)
db.foo.bar.count()
```
从下面的操作截图可以看出，三个数据组上的记录数分别为12,9,9。

3) 创建一个新的数据组和数据节点并启动
```
db = new Sdb
db.createRG( "group4" )
db.getRG("group4").createNode( "sdbserver1", 11850, "/opt/sequoiadb/database/data/11850/" )
db.getRG("group4").start()
quit
```

操作截图：
![添加新的数据组并启动](https://doc.shiyanlou.com/courses/1480/1207281/aabfde1029db2784fbb6d30462d10889)



4) 创建数据域2，对应所有数据组和数据节点
```
sdblist -l -m local
sdb
db = new Sdb
db.createDomain( 'dom2', ['group1', 'group2','group3','group4'], { AutoSplit: true } )
```
操作截图：
![创建新的数据域](https://doc.shiyanlou.com/courses/1480/1207281/08071425284a9026f32081196d065743)

5) 修改集合空间的数据域属性为数据域2
```
db.foo.alter({Domain:"dom2"})
```


6) 将集合的数据迁移部分到新的数据组上
```
db.foo.bar.split("group1","group4",30)
db.foo.bar.split("group2","group4",30)
db.foo.bar.split("group3","group4",30)
```

>Note:
>
>上面第一条命令的意思是把group1上的数据移30%到group4上


7) 连接各个数据节点检查一下
```
db = new Sdb("localhost",11820)
db.foo.bar.count()
db = new Sdb("localhost",11830)
db.foo.bar.count()
db = new Sdb("localhost",11840)
db.foo.bar.count()
db = new Sdb("localhost",11850)
db.foo.bar.count()
```

操作截图：
![扩容完成](https://doc.shiyanlou.com/courses/1480/1207281/54153d89d98ad6e61e7309725567f46a)

可以看到，四个数据组上的记录数分别为6,8,6,10,新创建的数据组group4上有10条记录

## 集群缩容
1) 将集合1在新数据组上的数据迁移回旧的数据组
```
db = new Sdb
db.foo.bar.split("group4","group1",40)
db.foo.bar.split("group4","group1",50)
db.foo.bar.split("group4","group1",100)
```

2) 连接各个数据节点检查一下
```
db = new Sdb("localhost",11820)
db.foo.bar.count()
db = new Sdb("localhost",11830)
db.foo.bar.count()
db = new Sdb("localhost",11840)
db.foo.bar.count()
db = new Sdb("localhost",11850)
db.foo.bar.count()
```

操作截图：
![缩容初始化](https://doc.shiyanlou.com/courses/1480/1207281/04915228bd02bb7f8e50329d13840c5c)

>Note:
>
>截图最后的报错信息说明foo.bar在新数据组上已没有对应的数据分区

3) 修改集合空间的数据域属性为数据域1
```
db = new Sdb
db.foo.alter({Domain:"dom1"})
```

4) 删除上一章新增加的数据组和数据节点
```
db.removeRG("group4")
```


5) 检查集群状态是否正常
```
quit
sdblist -l -m local
```

操作截图：
![缩容完成](https://doc.shiyanlou.com/courses/1480/1207281/ce754a641b1d348c4a55a06170498183)

可以看到，group4已经从集群中剔除。


## 四、删除测试数据，退出连接
```
sdb
db = new Sdb
db.dropCS("foo")
db.dropDomain("dom1")
db.dropDomain("dom2")
quit
```


## 总结

Sequoiadb是一个分布式数据库，可以存储海量的结构化和非结构化数据，并提供多种接口实例，以方便应用程序的访问。本课程简单介绍了如何完成巨杉数据库集群的扩容和缩容操作。

在使用split方法对数据进行迁移时，如果一条命令迁移的数据量太大，对系统的性能是有影响的，要将影响程度降到最低，建议对数据进行分批迁移。例如：对一张大表通过一条命令迁移50%的数据，可分为5条命令，每次迁移10%的数据。


