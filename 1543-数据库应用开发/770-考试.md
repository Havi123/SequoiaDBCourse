---
show: step
version: 3.0
---
# 考试

## JSON 实例应用开发挑战介绍

对分布式存储引擎中的数据，SequoiaDB 巨杉数据库支持通过 JSON API 的方式直接进行查询与修改。SequoiaDB 巨杉数据库存储引擎的交互式命令行界面为 SequoiaDB Shell，使用 JavaScript 作为其脚本开发语言。

### 知识点
1）创建集合空间和集合；

2）给集合插入数据；

3）更新集合中的数据；

4）删除集合中的数据；

### 挑战内容

1）创建域company_domain ，在域下创建集合空间 company ， 在集合空间下创建集合 employee ；  

2）给创建的 employee 集合插入下面 6 条数据；
    { "empno" : 10001 , "ename" : "Georgi" , "age" : 48 }
    { "empno" : 10002 , "ename" : "Bezalel" , "age" : 21 }
    { "empno" : 10003 , "ename" : "Parto" , "age" : 33 }
    { "empno" : 10004 , "ename" : "Chirstian" , "age" : 40 }
    { "empno" : 10005 , "ename" : "Kyoichi" , "age" : 23 }
    { "empno" : 10006 , "ename" : "Anneke" , "age" : 19 }

3）连接数据库查询集合 employees 中age 大于20，小于30的数据；

4）集合 employees 中的数据，将 empno 为10001的记录 age 更改为34；

5）删除集合 employees 中的数据，将 empno 为 10006 的记录删除；


### 挑战要求

1）正确创建集合空间和集合；

2）正确使用 JSON 的增、删、查、改功能；

### 实例代码

1）创建域;
```shell
var db = new Sdb ("localhost",11810) ;
db.createDomain ("company_domain", ["group1", "group2", "group3"], { AutoSplit : true }) ;
```

创建 company 集合空间；  
```shell
db.createCS ("company", { Domain : "company_domain" }) ;
```

创建 employee 集合； 
```shell
db.company.createCL ("employee", {"ShardingKey" : { "_id" : 1} , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false }) ;
```

2）插入数据；  
```shell
db.company.employee.insert ({ "empno" : 10001 , "ename" : "Georgi" , "age" : 48 }) ;
db.company.employee.insert ({ "empno" : 10002 , "ename" : "Bezalel" , "age" : 21 }) ;
db.company.employee.insert ({ "empno" : 10003 , "ename" : "Parto" , "age" : 33 }) ;
db.company.employee.insert ({ "empno" : 10004 , "ename" : "Chirstian" , "age" : 40 }) ;
db.company.employee.insert ({ "empno" : 10005 , "ename" : "Kyoichi" , "age" : 23 }) ;
db.company.employee.insert ({ "empno" : 10006 , "ename" : "Anneke" , "age" : 19 }) ;
```

3）查询集合 employees 中age 大于20，小于30的数据；  
```shell
db.company.employee.find ( { "age" : { "$gt" : 20 , "$lt" : 30 } } ) ;
```  

4）集合 employees 中的数据，将 empno 为10001的记录 age 更改为34；  
```shell
db.company.employee.update ( { "$set" : { "age" : 34 } } , { "empno" : 10001 }) ;
```

5） 删除集合 employees 中的数据，将 empno 为10006的记录删除； 
```shell 
db.company.employee.remove ( { "empno" : 10006 } ) ;
```

## SequoiaS3 挑战

SequoiaS3 系统实现通过 AWS S3 接口访问 SequoiaDB 的能力,SequoiaS3 将 S3 接口中的区域、桶和对象映射为 SequoiaDB 中的集合空间、集合，记录和Lob，实现桶的增、删、查，对象的增、删、查，对象的版本管理，以及分段上传的能力，支持从 Amazon S3 或其他实现 S3 接口的存储服务平滑迁移到 SequoiaDB 数据库。

#### 知识点

1）SequoiaDB 数据库事务使用；

2）SequoiaS3 实例创建;

3）SequoiaS3 实例使用；

### 挑战内容

1）在 SequoiaDB 数据库中开启 RC 级别事务，且配置等锁模式；

2）创建 SequoiaS3 元数据域 metaDomain 和数据文件域 dataDomain；

3）配置 SequoiaS3 实例，在 config/application.properties 中配置对外监听端口和 url 信息和域名；

4）启动 SequoiaS3 实例；

5）创建 s3user 用户且在该用户下创建桶 sdbbucket；

6）向 sdbbucket 桶中写入 /opt/sequoiadb/tools/sequoias3/ 目录下的文件 "sequoia-s3-3.4.jar"，在 SequoiaS3 重命名名 "sdbs3.jar"，连接数据库检查文件是否上传成功；

7）从桶 sdbbucket 中读取文件对象 “sdbs3.jar”，并存放到本地目录 sdbs3.jar 文件中。

### 挑战要求

正确配置并使用 SequoiaS3

### 示例代码

```shell
#开启事务级别
sdb
var db = new Sdb ("localhost", 11810) ;
db.updateConf ( { transactionon : true , transisolation : 1 ,  translockwait : true } ) ;

#配置 SequoiaS3 实例
vim /opt/sequoiadb/tools/sequoias3/config/application.properties

#创建域
db.createDomain("domain1", ["datagroup"], { AutoSplit : true } ) ;

#配置对外监听端口
server.port=8002
#配置 coord 节点的 IP 和端口，可以配置多组并使用逗号分隔
sdbs3.sequoiadb.url=sequoiadb://localhost:11810
sdbs3.sequoiadb.meta.domain=metaDomain
sdbs3.sequoiadb.data.domain=dataDomain

#启动 SequoiaS3 实例
/opt/sequoiadb/tools/sequoias3/sequoias3.sh start

#创建用户
curl -v -X POST "http://localhost:8002/users/?Action=CreateUser&UserName=s3user&role=admin" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD"

#创建桶
curl -v -X PUT "http://localhost:8002/sdbbucket" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD" 

#向桶上传文件
curl -X PUT -T "/opt/sequoiadb/tools/sequoias3/sequoia-s3-3.4.jar" "http://localhost:8002/sdbbucket/sdbs3.jar" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD"  -H "Content-Type: text/plain"

#从桶 sdbbucket 中读取文件对象 “sdbs3.jar”，并存放到本地目录 sdbs3.jar 文件中
curl -o sdbs3.jar -X GET "http://localhost:8002/sdbbucket/sdbs3.jar" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD"  -H "Content-Type: text/plain" 
```

## SequoiaFS 挑战

SequoiaFS 文件系统是基于 FUSE 在 Linux 系统下实现的一套文件系统,相当于用数据库做一个文件目录,其原理为 SequoiaFS 利用 SequoiaDB 的元数据集合存储文件和目录的属性信息，lob 对象存储文件的数据内容，从而实现了类似NFS分布式网络文件系统。用户可以将远程 SequoiaDB 的某个目标集合通过映射的方式挂载到本地 FS 节点，在 FS 节点的挂载目录下实现通过通用文件系统API对文件和目录进行操作

#### 知识点
1）创建集合空间和集合；

2）启动 SequoiaFS 服务；

3）SequoiaFS 正常使用；

### 挑战内容
1） 创建 fs_domain 域使用,在此域下创建集合空间 fscs，在此集合空间下创建集合 fscl ；

2) 创建挂载点目录" /opt/sequoiadb/sequoiafs/mountpoint "；

3) 创建 SequoiaFS 的配置文件夹" /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/ "和日志目录" /opt/sequoiadb/sequoiadb/sequoiafs/log/fscs_fscl/001/ " ；

4) 生成一个空的配置文件，SequoiaFS 服务在启动时会将指定的值写入该文件中，其他参数使用缺省值" /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/sequoiafs.conf " ；

5) 启动 SequoiaFS 服务 ；

6) 在 mount 目录创建 fsdir 文件夹,且在创建的 fsdir 文件夹下创建文件 fsfile.txt 向文件中写入 " hello, this is a fsfile! "；

7) 在数据库检查是否将文件夹中的文件挂载上去 ；

8）将挂载文件夹删除，检查数据库中是否已经把 LOB 记录删除 。

 
### 示例代码

连接数据库查询
```shell
sdb 'db = new Sdb("localhost",11810)'
sdb 'db.list(4)'|grep sequoiafs
```

创建挂载点

```shell
mkdir -p /opt/sequoiadb/mountpoint
```

创建配置文件夹
```shell
mkdir -p /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/
mkdir -p /opt/sequoiadb/sequoiafs/log/fscs_fscl/001/
```
创建配置文件
```shell
touch /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/sequoiafs.conf
```
启动服务

```shell
sequoiafs /opt/sequoiadb/sequoiafs/mountpoint -i localhost:11810 -l fscs.fscl --autocreate -c /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/ --diagpath  /opt/sequoiadb/sequoiafs/log/fscs_fscl/001/ -o big_writes -o max_write=131072 -o max_read=131072
```

创建文件夹且写入文件

```shell
mkdir -p /opt/sequoiadb/sequoiafs/mountpoint/fsdir
cd /opt/sequoiadb/sequoiafs/mountpoint/fsdir
echo 'hello, this is a fsfile!' >> fsfile.txt
```

检查Lob文件
```shell
var db = new Sdb ("localhost", 11810) ;
db.sequoiafs.fscl_file142361856883863522.find();
db.sequoiafs.fscl_dir142361856883863522.find();
db.fscs.fscl.listLobs();
```
