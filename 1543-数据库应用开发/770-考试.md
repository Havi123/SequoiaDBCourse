---
show: step
version: 3.0
---
# 考试

## 挑战介绍

SequoiaS3 系统实现通过 AWS S3 接口访问 SequoiaDB 的能力,SequoiaS3 将 S3 接口中的区域、桶和对象映射为 SequoiaDB 中的集合空间、集合，记录和Lob，实现桶的增、删、查，对象的增、删、查，对象的版本管理，以及分段上传的能力，支持从 Amazon S3 或其他实现 S3 接口的存储服务平滑迁移到 SequoiaDB 数据库。

#### 知识点

使用 SequoiaS3 对象存储;

## 挑战内容

1）在 SequoiaDB 数据库中开启 RC 级别事务，且配置等锁模式；

2）创建 SequoiaS3 元数据域 metaDomain 和数据文件域 dataDomain；

3）配置 SequoiaS3 实例，在 config/application.properties 中配置对外监听端口和 url 信息和域名；

4）启动 SequoiaS3 实例；

5）创建 s3user 用户且在该用户下创建桶 sdbbucket；

6）向 sdbbucket 桶中写入 /opt/sequoiadb/tools/sequoias3/ 目录下的文件 "sequoia-s3-3.4.jar"，在 SequoiaS3 重命名名 "sdbs3.jar"，连接数据库检查文件是否上传成功；

7）从桶 sdbbucket 中读取文件对象 “sdbs3.jar”，并存放到本地目录 sdbs3.jar 文件中。

## 挑战要求

正确配置并使用 SequoiaS3 

## 示例代码

```shell
#开启事务级别
sdb
var db = new Sdb ("localhost", 11810) ;
db.updateConf ( { transactionon : true , transisolation : 1 ,  translockwait : true } ) ;

#配置 SequoiaS3 实例
vim /opt/sequoiadb/tools/sequoias3/config/application.properties

#创建域
db.createDomain("domain1", ["datagroup"], { AutoSplit : true } ) ;

#配置对外监听端口
server.port=8002
#配置 coord 节点的 IP 和端口，可以配置多组并使用逗号分隔
sdbs3.sequoiadb.url=sequoiadb://localhost:11810
sdbs3.sequoiadb.meta.domain=metaDomain
sdbs3.sequoiadb.data.domain=dataDomain

#启动 SequoiaS3 实例
/opt/sequoiadb/tools/sequoias3/sequoias3.sh start

#创建用户
curl -v -X POST "http://localhost:8002/users/?Action=CreateUser&UserName=s3user&role=admin" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD"

#创建桶
curl -v -X PUT "http://localhost:8002/sdbbucket" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD" 

#向桶上传文件
curl -X PUT -T "/opt/sequoiadb/tools/sequoias3/sequoia-s3-3.4.jar" "http://localhost:8002/sdbbucket/sdbs3.jar" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD"  -H "Content-Type: text/plain"

#从桶 sdbbucket 中读取文件对象 “sdbs3.jar”，并存放到本地目录 sdbs3.jar 文件中
curl -o sdbs3.jar -X GET "http://localhost:8002/sdbbucket/sdbs3.jar" -H "Host: localhost:8002" -H "Authorization: AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD"  -H "Content-Type: text/plain" 
```

## 挑战介绍

SequoiaFS 文件系统是基于 FUSE 在 Linux 系统下实现的一套文件系统,相当于用数据库做一个文件目录,其原理为 SequoiaFS 利用 SequoiaDB 的元数据集合存储文件和目录的属性信息，lob 对象存储文件的数据内容，从而实现了类似NFS分布式网络文件系统。用户可以将远程 SequoiaDB 的某个目标集合通过映射的方式挂载到本地 FS 节点，在 FS 节点的挂载目录下实现通过通用文件系统API对文件和目录进行操作

#### 知识点

NFS文件系统的使用

## 挑战内容
1） 创建 fs_domain 域使用,在此域下创建集合空间 fscs，在此集合空间下创建集合 fscl ；

2) 创建挂载点目录" /opt/sequoiadb/sequoiafs/mountpoint "；

3) 创建sequoiafs的配置文件夹" /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/ "和日志目录" /opt/sequoiadb/sequoiadb/sequoiafs/log/fscs_fscl/001/ " ；

4) 生成一个空的配置文件，SequoiaFS 服务在启动时会将指定的值写入该文件中，其他参数使用缺省值" /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/sequoiafs.conf " ；

5) 启动 sequoiafs 服务 ；

6) 在 mount 目录创建 fsdir 文件夹,且在创建的 fsdir 文件夹下创建文件 fsfile.txt 向文件中写入 " hello, this is a fsfile! "；

7) 在数据库检查是否将文件夹中的文件挂载上去 ；

8）将挂载文件夹删除，检查数据库中是否已经把 LOB 记录删除 。

 
## 示例代码

连接数据库查询
```shell
sdb 'db = new Sdb("localhost",11810)'
sdb 'db.list(4)'|grep sequoiafs
```

创建挂载点

```shell
mkdir -p /opt/sequoiadb/mountpoint
```

创建配置文件夹
```shell
mkdir -p /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/
mkdir -p /opt/sequoiadb/sequoiafs/log/fscs_fscl/001/
```
创建配置文件
```shell
touch /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/sequoiafs.conf
```
启动服务

```shell
sequoiafs /opt/sequoiadb/sequoiafs/mountpoint -i localhost:11810 -l fscs.fscl --autocreate -c /opt/sequoiadb/sequoiafs/conf/fscs_fscl/001/ --diagpath  /opt/sequoiadb/sequoiafs/log/fscs_fscl/001/ -o big_writes -o max_write=131072 -o max_read=131072
```

创建文件夹且写入文件

```shell
mkdir -p /opt/sequoiadb/sequoiafs/mountpoint/fsdir
cd /opt/sequoiadb/sequoiafs/mountpoint/fsdir
echo 'hello, this is a fsfile!' >> fsfile.txt
```

检查Lob文件
```shell
var db = new Sdb ("localhost", 11810) ;
db.sequoiafs.fscl_file142361856883863522.find();
db.sequoiafs.fscl_dir142361856883863522.find();
db.fscs.fscl.listLobs();
```
