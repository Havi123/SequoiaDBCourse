---
show: step
version: 2.0
enable_checker: true
---
# 多维分区规划

## 课程介绍

本课程主要介绍巨杉数据库中多维分区的规划。通过本课程了多维分区的概念，掌握域多维分区的使用方法。

#### 请点击右侧选择使用的实验环境

#### 部署架构：

本课程中的SequoiaDB巨杉数据库的集群拓扑结构为三分区单副本。

![图片描述](https://doc.shiyanlou.com/courses/1544/1207281/edad10d1fca39ab74e2d0a1c01d34154)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

**实验环境**

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。

## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库的操作系统用户为 sdbadmin。

```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本

```
sequoiadb --version
```
操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/b4082b0d6d6bdf89d229aa713a53759d)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/02fcaa58ac27e91688ead137fa748d6e)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤

## 创建多维分区表

多维分区表是一个range-hash的分区表，由主集合和子集合两部分组成。

主集合为一个逻辑结构，用于连接所有子集合。真正的数据存储于子集合之中。

1）通过 Linux 命令行进入 SequoiaDB Shell；

```
sdb
```

2）通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ("localhost", 11810) ;
```

3）创建域；
```javascript
db.createDomain ( 'company_domain', [ 'group1', 'group2', 'group3'], { AutoSplit: true } )
```

4）创建集合空间；

```javascript
db.createCS('company', { Domain : 'company_domain' } ) ;
```

5）创建主表集合；
```javascript
db.maincs.createCL('log', { IsMainCL : true , ShardingKey : {'tx_time' : 1 } , ShardingType : 'range' } ) ;
```

3）创建子集合

首先创建子集合的专用集合空间。

```javascript
db.createCS('year2020', { Domain : 'company_domain' }) ;
db.createCS('year2021', { Domain : 'company_domain' }) ;
```

创建两个子集合

创建子集合 year2020.log

```javascript
db.year2020.createCL('log',{"ShardingKey" : { "_id" : 1 } , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false })
```

创建子集合 year2021.log

```javascript
db.year2020.createCL('log',{"ShardingKey" : { "_id" : 1 } , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false })
```

4）集合关联

子集合 year2020.log 保存小于2021年的数据

```javascript
db.company.log.attachCL('year2020.log', { LowBound : { 'tx_time' : MinKey() } , UpBound : { tx_time : { '$date' : '2021-01-01' } } } ) ;
```

子集合 year2021.log 保存大于等于2021年的数据

```javascript
db.company.log.attachCL('year2021.log', { LowBound : { 'tx_time' : { '$date' : '2021-01-01' } } , UpBound : MaxKey() }) ;
```

这里的$date表示字段tx_time的数据类型为date型。

更多数据类型请参考：[http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519612299-edition_id-304](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519612299-edition_id-304)

5）插入数据

```javascript
db.company.log.insert( { serial_no : 1 , account_id : '1001' , description : "login" , tx_time : { '$date' : '2020-03-02' } } ) ;
db.company.log.insert( { serial_no : 2 , account_id : '1001' , description : "login" , tx_time : { '$date' : '2021-03-02' } } ) ;
```

6）查询数据分布；
查询2020年数据子集合数据情况。
```javascript
db.year2020.log.count() ;
```

查询2021年数据子集合数据情况。
```javascript
db.year2020.log.count() ;
```

7）关闭 db 连接；
```javascript
db.close() ;
```


8）退出 SequoiaDB Shell；
```javascript
quit ;
```



## Mysql实例关联多维分区表

1）登录MySQL实例；


```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```


2）MySQL创建数据库；

```sql
CREATE DATABASE company ;
USE company ;
```

由于maincs集合在SDB已存在，此时MySQL的create database 语句只是和SDB的集合空间做了关联操作。

3）MySQL创建表；

进入 company 库，后执行建表语句。

```
CREATE TABLE log(
    serial_no INT,
    account_id VARCHAR(20),
    description TEXT,
    tx_time DATE
);
```

4）数据查询；

```
select * from log;
```
> 此时可以查询到已存在的数据。

5）MySQL实例中插入数据；

通过MySQL实例插入的数据，最终按照分区规则，保存在巨杉数据库中。

```
INSERT INTO  log  VALUES (3, 000001, 'LOGIN ...', 2020-05-21);
```

6）数据查询；

```
select * from log;
```

## 总结
本课程介绍了多维分区的概念，以日志表为例子，创建2020和2021年的子表挂载到主表上，同时介绍了多维分区表如何关联到 MySQL 实例的表中。
