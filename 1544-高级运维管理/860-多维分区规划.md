---
show: step
version: 1.0
enable_checker: true
---

# 多维分区规划

## 课程介绍

本课程主要介绍巨杉数据库中多维分区的规划。通过本课程了多维分区的概念，掌握域多维分区的使用方法。

**请点击右侧选择使用的实验环境**

**部署架构**

本课程中的SequoiaDB巨杉数据库的集群拓扑结构为三分区单副本。

**实验环境**

课程使用的实验环境为Ubuntu Linux 16.04 64位版本。

## 查看数据库状态

`sdblist  -t all -l -m local`

**操作截图：**

![860-1](https://doc.shiyanlou.com/courses/1544/1207281/365946f544b3dbd39a2d6c1d6fc13fcd)

## 创建多维分区表

多维分区表是一个range-hash的分区表，由主集合和子集合两部分组成。

主集合为一个逻辑结构，用于连接所有子集合。真正的数据存储于子集合之中。

1）登录sdb控制台

切换至sdbadmin用户后，登录SDB控制台，并连接数据库。

```
db=new Sdb()
```

操作截图：

 ![860-2](https://doc.shiyanlou.com/courses/1544/1207281/ac8f0b846ea689b2bd7b0699de13c99f)

2）创建主集合

1）创建主集合

```
db.createCS('maincs')
db.maincs.createCL('maincl',{IsMainCL:true,ShardingKey:{'tx_time':1},ShardingType:'range'})
```

2）创建域

域中包含的数据组用于子集合存储数据。

```
db.createDomain('mydomain',['group1','group2','group3'])
```

3）创建子集合

首先创建子集合的专用集合空间。

```
db.createCS('year2020',{Domain:'mydomain'})
```

创建两个子集合

创建子集合year2020.month\_1_6

```
db.year2020.createCL('month_1_6',{ShardingKey:{"account_id":1},ShardingType:"hash",Partition:4096,Compressed:true,AutoSplit:true })
```

创建子集合year2020.month\_7_12

```
db.year2020.createCL('month_7_12',{ShardingKey:{"account_id":1},ShardingType:"hash",Partition:4096,Compressed:true,AutoSplit:true})
```

4）集合关联

子集合year2020.month\_1_6保存2020年1月至6月的数据

```
db.maincs.maincl.attachCL('year2020.month_1_6',{LowBound:{'tx_time':{'$date':'2020-01-01'}},UpBound:{tx_time:{'$date':'2020-07-01'}}})
```

子集合year2020.month\_7_12保存2020年7月至12月的数据

```
db.maincs.maincl.attachCL('year2020.month_7_12',{LowBound:{'tx_time':{'$date':'2020-07-01'}},UpBound:{tx_time:{'$date':'2021-01-01'}}})
```

这里的$date表示字段tx_time的数据类型为date型。

更多数据类型请参考：[http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519612299-edition_id-304](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519612299-edition_id-304)

5）插入数据

```
db.maincs.maincl.insert({tx_id:1,account_id:'1001',tx_time:{'$date':'2020-03-02'}})
```



## Mysql实例关联多维分区表

1）登录MySQL实例

```
mysql -uroot -h127.0.0.1
```

操作截图：

 ![860-3](https://doc.shiyanlou.com/courses/1544/1207281/e5760425c15f1e51a639052b1b53d9ee)

2）MySQL创建数据库

```
create database maincs;
```

由于maincs集合在SDB已存在，此时MySQL的create database 语句只是和SDB的集合空间做了关联操作。

3）MySQL创建表

进入maincs库，后执行建表语句。

```
use maincs;
create table maincl(tx_id int,account_id varchar(20),tx_time date);
```

4）数据查询

```
select * from maincl;
```

此时可以查询到已存在的数据。

5）MySQL实例中插入数据

通过MySQL实例插入的数据，最终按照分区规则，保存在巨杉数据库中。

```
insert into maincl(tx_id,account_id,tx_time) values(1,'0001',2020-05-21);
select * from maincl;
```

最后可以通过SDB控制台查看，数据的保存状态。

```
db=new Sdb()
db.snapshot(SDB_SNAP_COLLECTIONS)
```
