```
show: step
version: 1.0
enable_checker: true

```

# 诊断日志分析

## 课程介绍

本课程主要介绍巨杉数据库的诊断日志，通过诊断日志内容来定位问题。

**请点击右侧选择使用的实验环境**

**部署架构**

本课程中的SequoiaDB巨杉数据库的集群拓扑结构为三分区单副本。

**实验环境**

课程使用的实验环境为Ubuntu Linux 16.04 64位版本。

## 查看数据库状态

`sdblist  -t all -l -m local`

**操作截图：**

![890-1](https://doc.shiyanlou.com/courses/1544/1207281/4586ea0ef26ab29a0bbc334d588102f6)

## 初始化环境

使用sdbadmin用户执行如下shell脚本。

```
#!/bin/bash
mysql -uroot -h127.0.0.1 -e "drop database if exists company;create database  if not exists company;"
mysql -uroot -h127.0.0.1 -e "drop table if exists company.order_info;create table if not exists company.order_info(order_id int AUTO_INCREMENT PRIMARY KEY,product_name varchar(20),price float(5,2));"
mysql -uroot -h127.0.0.1 -e "insert into company.order_info(product_name,price)values('pic',128.21)"
sdbstop -p 11820
```

## 查询数据库

在sdbadmin用户下执行如下SQL语句

```
mysql -uroot -h127.0.0.1 -Dcompany -e "select * from order_info;"
```

此时数据查询报错。

操作截图：

 ![890-2](https://doc.shiyanlou.com/courses/1544/1207281/bd861250a00edf84f6a85d90d71965bf)

## 诊断日志分析

1）查看诊断日志存放路径

登录SDB的控制台后，连接SDB，并执行如下语句进行插叙

```
db.snapshot(SDB_SNAP_CONFIGS,{},{NodeName:null,diagpath:null})
```

该语句会列出集群中所有协调节点和数据节点的日志路径。

2）打开日志文件

进入日志文件所在的文件夹，打开日志文件sdbdiag.log。

如有关键字ERROR，则说明数据库有报错。并根据RC后面的错误代码查看具体错误信息。这里的错误代码为-79
![890-3](https://doc.shiyanlou.com/courses/1544/1207281/8634618fe0663b59cec305a0fbeed609)

具体错误代码请参考如下链接：

[http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190985-edition_id-0](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190985-edition_id-0)

3）定位具体服务节点

根据NodeID定位到发生错误的具体节点,查看该节点的诊断日志文件。

```
db.list(SDB_LIST_GROUPS,{GroupID:1002},{})
```

同时可以查看SDB的数据库状态视图，查看数据状态。

```
db.snapshot(SDB_SNAP_DATABASE,{},{ErrNodes:null})
```

操作截图：

 ![890-4](https://doc.shiyanlou.com/courses/1544/1207281/96bf2513d7bea30ad90f03ab62500992)

group1数据节点服务未启动,启动group1。

在linux中直接执行如下命令，启动所有服务。

```
sdbstart -t all
```

操作截图：

 ![890-5](https://doc.shiyanlou.com/courses/1544/1207281/de698eb2bc1e7af0184ae850f967731f)
