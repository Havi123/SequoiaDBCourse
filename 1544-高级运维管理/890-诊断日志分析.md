---
show: step
version: 1.0
enable_checker: true
---

# 诊断日志分析

## 课程介绍

本课程主要介绍巨杉数据库的诊断日志，通过诊断日志内容来定位问题。

#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-MySQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/8d88e6faed223a26fcdc66fa2ef8d3c5)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。


## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库和 SequoiaSQL-MySQL 实例的操作系统用户为 sdbadmin。
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本

```
sequoiadb --version
```
操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/b4082b0d6d6bdf89d229aa713a53759d)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/02fcaa58ac27e91688ead137fa748d6e)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤


## 创建数据库及数据表

进入 MySQL shell ，连接 SequoiaSQL-MySQL 实例并创建 company 数据库实例，为接下来验证 MySQL 语法特性做准备。

#### 登录 MySQL shell 

```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

#### 创建数据库实例

```sql
CREATE DATABASE company ;
USE company ;
```

#### 创建数据表
在 SequoiaSQL-MySQL 实例中创建的表将会默认使用 SequoiaDB 数据库存储引擎，包含主键或唯一键的表将会默认以唯一键作为分区键，进行自动分区。


1）创建包含自增主键字段的 employee 表；

```sql
CREATE TABLE employee (empno INT AUTO_INCREMENT PRIMARY KEY, ename VARCHAR(128), age INT) ;
```

2）基本的数据写入操作；

```sql
INSERT INTO employee (ename, age) VALUES ("Jacky", 36) ;
INSERT INTO employee (ename, age) VALUES ("Alice", 18) ;
```

3）退出 MySQL Shell；

```
\q
```

## 错误码分析
目前集群为正常状态，我们停止一个节点模拟节点故障的情况；

1）停止 11820 数据节点；
```
sdbstop -p 11820
```


2）登录 MySQL shell；

```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

3）查询数据；

```
SELECT * FROM company.employee ;
```

操作截图：

 ![890-2](https://doc.shiyanlou.com/courses/1544/1207281/bd861250a00edf84f6a85d90d71965bf)

目前错误码分为：
- MySQL 错误码：
 来自 MySQL 的错误码范围为 1~4000。可以通过 perror 工具获取错误码的描述信息。perror 工具位于安装目录的 bin 目录下。如以下例子，在默认的安装配置下，获取 157 错误的描述信息。
 
- SequoiaDB 错误码：
来自 SequoiaDB 的错误码范围为 40000~50000。由于 MySQL 上的错误码需为正数，而 SequoiaDB 上错误码为负数，因此 SequoiaSQL-MySQL 对原 SequoiaDB 的错误码进行了范围的调整。SequoiaSQL-MySQL 上的 SequoiaDB 错误码（记为 ssql_code）与 SequoiaDB 原本的错误码（记为 sdb_code），可根据公式转换 `sdb_code = -(ssql_code - 40000)` 。 获取 sdb_code 的错误码描述信息，可以通过在 sdb shell 中执行getErr(<error code>)方法，或查阅错误码列表



4）根据转换公式从图片的错误码40250计算得出 SequoiaDB 对应错误码为 -250（节点处于业务故障状态）




## 错误日志分析

1）查看诊断日志存放路径

登录SDB的控制台后，连接SDB，并执行如下语句进行插叙

```
db.snapshot( SDB_SNAP_CONFIGS , {} , { NodeName : null , diagpath : null } ) ;
```

该语句会列出集群中所有协调节点和数据节点的日志路径。

2）打开日志文件

进入日志文件所在的文件夹，打开日志文件sdbdiag.log。

如有关键字ERROR，则说明数据库有报错。并根据RC后面的错误代码查看具体错误信息。这里的错误代码为-79
![890-3](https://doc.shiyanlou.com/courses/1544/1207281/8634618fe0663b59cec305a0fbeed609)

具体错误代码请参考如下链接：

[http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190985-edition_id-0](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190985-edition_id-0)

3）定位具体服务节点

根据NodeID定位到发生错误的具体节点,查看该节点的诊断日志文件。

```
db.list( SDB_LIST_GROUPS ,{ GroupID : 1002 } , {} ) ;
```

同时可以查看SDB的数据库状态视图，查看数据状态。

```
db.snapshot( SDB_SNAP_DATABASE , {} , { ErrNodes:"" }) ;
```

操作截图：

 ![890-4](https://doc.shiyanlou.com/courses/1544/1207281/96bf2513d7bea30ad90f03ab62500992)

4）group1 数据节点服务未启动 ， 启动 group1 的11820节点；

```
sdbstart -p 11820
```

操作截图：

 ![890-5](https://doc.shiyanlou.com/courses/1544/1207281/de698eb2bc1e7af0184ae850f967731f)

#### 验证集群是否可用
1）登录 MySQL shell；

```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

2）查询数据；

```
SELECT * FROM company.employee ;
INSERT INTO employee (ename, age) VALUES ("Ben", 21) ;
```
> 此时数据服务已经恢复正常，能够正常写入和查询；

3）退出 MySQL Shell；
```
quit ;
```

## 总结

本课程模拟了当服务不正常时，如何根据错误码，初步分析得出问题原因，也介绍了通过数据库日志等方法诊断日志。
