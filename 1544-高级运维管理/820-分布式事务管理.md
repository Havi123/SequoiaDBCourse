---
show: step
version: 1.0
enable_checker: true
---

# 分布式事务管理

## 课程介绍


本课程主要介绍巨杉数据库的事务功能，通过实验来检验数据库的事务处理能力。

#### 请点击右侧选择使用的实验环境

#### 部署架构：
本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-MySQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/8d88e6faed223a26fcdc66fa2ef8d3c5)

详细了解 SequoiaDB 巨杉数据库系统架构：
* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境
课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。


## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库和 SequoiaSQL-MySQL 实例的操作系统用户为 sdbadmin。
```
su - sdbadmin
```
>Note:
>
>用户 sdbadmin 的密码为 sdbadmin

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本

```
sequoiadb --version
```
操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/b4082b0d6d6bdf89d229aa713a53759d)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表

```
sdblist 
```

操作截图：

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/02fcaa58ac27e91688ead137fa748d6e)

>Note:
>
>如果显示的节点数量与预期不符，请稍等初始化完成并重试该步骤


## 创建数据库及数据表

进入 MySQL shell ，连接 SequoiaSQL-MySQL 实例并创建 company 数据库实例，为接下来验证 MySQL 语法特性做准备。

#### 登录 MySQL shell 

```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

#### 创建数据库实例

```sql
CREATE DATABASE company ;
USE company ;
```

#### 创建数据表
在 SequoiaSQL-MySQL 实例中创建的表将会默认使用 SequoiaDB 数据库存储引擎，包含主键或唯一键的表将会默认以唯一键作为分区键，进行自动分区。


1）创建包含自增主键字段的 employee 表；

```sql
CREATE TABLE employee (
    empno INT AUTO_INCREMENT PRIMARY KEY, 
    ename VARCHAR(128), 
    age INT
) ;
```

2）写入数据；

```sql
INSERT INTO employee (ename, age) VALUES ("Jacky", 36) ;
```

3）退出 MySQL Shell；
```
\q
```


## 检查是否开启事务

检验 SequoiaDB 巨杉数据库节点事务是否开启。

1）在 Linux 命令行中进入 SequoiaDB Shell 交互式界面；

```
sdb
```

2）使用 JavaScript 连接协调节点，并获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

3）查询节点配置快照；
```
db.snapshot(SDB_SNAP_CONFIGS, {}, { NodeName : "" , transactionon : "" } )
```

如果transactionon参数返回为true表示事务功能已经开启。事务功能默认为开启状态。

4）退出 SequoiaDB Shell；
```
quit ;
```



## 事务的原子性

1）登录 MySQL shell；

```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

2）切换数据库；

```
USE company ;
```

2）查看数据

```
select * from employee ;
```

3）开启事务操作

原子性保证在同一个事务内所有操作一起成功或者一起失败。

开始事务；

```sql
BEGIN ;
```

写入数据；

```sql
INSERT INTO employee (ename, age) VALUES ("Alice", 18) ;
```

更新数据；

```sql
UPDATE employee SET age = 37 where ename = "Jacky" ;
```

查看数据情况；

```
select * from employee ;
```

提交事务；

```sql
ROLLBACK ;
```

再次查看数据

```
select * from employee ;
```

上一步的rollback把同一事务内的所有操作进行了回滚。


## 事务的持久性
1）开始事务；

```sql
BEGIN ;
```

2）写入数据；

```sql
INSERT INTO employee (ename, age) VALUES ("Susan", 21) ;
```

3）提交事务；

```sql
COMMIT ;
```

4）查询写入数据，确保之前写入的数据被正确提交；

```sql
SELECT * FROM ename = "Susan" ;
```

由于事务已经被提交，被插入的数据被保存在数据库中。



## 事务的隔离

#### 设置隔离级别--RU 读未提交

1）修改隔离级别

登录SDB控制台，连接数据库后，修改隔离界别。

在 Linux 命令行中进入 SequoiaDB Shell 交互式界面；

```
sdb
```

使用 JavaScript 连接协调节点，并获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

查询节点配置快照,0代表读未提交；

```
db.updateConf ( { transisolation : 0 } , { Global : true } )
```

> Note:
> - transisolation参数指定隔离界别，0表示隔离界别为读未提交。
> - Global为true表示对所有节点生效。
> - 关于更多参数说明，请参考如下链接：
[http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190643-edition_id-0](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190643-edition_id-0)

退出 SequoiaDB Shell；
```
quit ;
```


2）修改数据
开启第一个终端，登录MySQL，这个终端表示sessionA，开启事务后修改数据。

登录 MySQL shell；

```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

开启事务；

```
begin;
```

更新数据；

```
updae company.employee set age = 22 where ename = "Susan" ;
```

3）查询结果
开启第二个终端，登录MySQL，表示sessionB；

登录 MySQL shell；

```
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

使用sessionB开启事务后查询；

```
select * from company.employee;
```

可以看到，即使sessionA未进行提交，SessionB 依然可以看到修改过的数据。

#### RC读已提交

1）修改隔离级别

登录SDB控制台，连接数据库后，修改隔离界别。

在 Linux 命令行中进入 SequoiaDB Shell 交互式界面；

```
sdb
```

使用 JavaScript 连接协调节点，并获取数据库连接；

```javascript
var db = new Sdb ("localhost",11810) ;
```

查询节点配置快照,1代表读已提交；

```
db.updateConf ( { transisolation : 1 } , { Global : true } )
```


2）修改数据
开启第一个终端，登录MySQL，这个终端表示sessionA。

sessionA

```
begin;
update company.order_info set price=4.00 where order_id=1;
```

开启第二个终端，登录MySQL，表示sessionB。

sessionB

```
begin;
select * from company.order_info;
```

此时sessionB无法看到修改后的数据。

3）提交后查询结果
sessionA执行提交操作

```
commit;
```

sessionB执行查询

```
select * from company.order_info
```

只有当数sessionA据提交后，sessionB才能看到修改后的数据。

### RS读稳定性

1）修改隔离级别

登录SDB控制台，连接数据库后，修改隔离界别。

```
sdb=new Sdb()
db.updateConf({transisolation:2},{Global:true})
```

transisolation参数指定隔离界别，2表示隔离界别为读已提交。

2）查询数据
开启第一个终端，登录MySQL，这个终端表示sessionA。

使用sessionA开启事务后查询数据。

```
begin
select * from company.order_info;
```

3）修改数据
开启第二个终端，登录MySQL，表示sessionB。

```
begin;
update company.order_info set price=5.00 where order_id=1;
```

sessionB的update操作发生等待，只有等sessionA执行rollback或者commit后，
sessionB才能执行成功。
