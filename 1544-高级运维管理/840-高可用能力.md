---
show: step
version: ４.0
enable_checker: true
---

# 数据库高可用

## 课程介绍

本课程主要介绍巨杉数据库的高可用能力。在一个三副本的高可用集群环境中，当数据组中一个数据节点出现故障后，整个集群依然能对外提供服务。


#### 部署架构

本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区三副本，其中包括 3 个引擎协调节点，1 个编目节点与 3 个数据组并部署了 1 个 SequoiaSQL-MySQL 数据库实例节点。

![840-1](https://doc.shiyanlou.com/courses/1544/1207281/67f646f26d1f110709f127fd39bc9958-0)

关于 SequoiaDB 巨杉数据库系统架构的详细信息，请参考如下链接：

* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。

## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库的操作系统用户为 sdbadmin。

```shell
su - sdbadmin
```

>Note:
>
>用户 sdbadmin 的密码为 `sdbadmin`

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本。

```shell
sequoiadb --version
```

操作截图：

![840-2](https://doc.shiyanlou.com/courses/1469/1207281/b4082b0d6d6bdf89d229aa713a53759d)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表。

```shell
sdblist  -t all -l -m local
```

操作截图：

 ![840-3](https://doc.shiyanlou.com/courses/1544/1207281/a10f6d46b7911a7659f95f14453754ff-0)

>Note:
>
>如果显示的节点数量与预期不符，请稍等节点初始化完成后再重试该步骤。

## 创建数据库及数据表

进入 MySQL Shell ，连接 SequoiaSQL-MySQL 实例并创建 company 数据库，为接下来验证 MySQL 语法特性做准备。

#### 登录 MySQL Shell 

```shell
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

#### 创建数据库实例

```sql
CREATE DATABASE company ;
USE company ;
```

#### 创建数据表

在 SequoiaSQL-MySQL 实例中创建的表将会默认使用 SequoiaDB 数据库存储引擎，包含主键或唯一键的表将会默认以唯一键作为分区键，进行自动分区。

1）创建包含自增主键字段的 employee 表；

```sql
CREATE TABLE employee (
    empno INT AUTO_INCREMENT PRIMARY KEY,
    ename VARCHAR(128),
    age INT
) ;
```

2）基本的数据写入操作；

```sql
INSERT INTO employee (ename, age) VALUES ("Jacky", 36) ;
```

3）查看数据；

```sql
SELECT * FROM employee ;
```

4）退出 MySQL Shell；

```sql
\q
```

## 关闭巨杉数据库节点服务

关闭每组数据节点中的一个数据节点，来模式数据发生故障。数据库总共有三个数据组（三个数据组分别是 group1，group2，group3 ），每个数据组关闭一个数据节点，因此总共关闭了三个数据节点。

1）关闭数据节点；

```shell
sdbstop -p 21820,21830,21840
```

2）查看数据库状态；

```shell
sdblist -t all -l -m local
```

操作截图：

 ![840-4](https://doc.shiyanlou.com/courses/1544/1207281/3625bbe4ca651c235987e4b23b1dcda5-0)

## 验证数据库功能

#### 登录 MySQL 验证

1）登录 MySQL Shell;

```shell
/opt/sequoiasql/mysql/bin/mysql -h 127.0.0.1 -P 3306 -u root
```

2）切换到 company 数据库；

```sql
USE company ;
```

3）进行数据写入操作；

```sql
INSERT INTO employee (ename, age) VALUES ("Alice", 18) ;
```

4）进行数据查询操作；

```sql
SELECT * FROM employee ;
```

5）退出 MySQL Shell；

```sql
\q
```

## 总结

通过本课程，我们验证了节点为三副本时，有 1 个节点损坏依然可以提供读写能力，证明了 SequoiaDB 巨杉数据库的高可用能力。
