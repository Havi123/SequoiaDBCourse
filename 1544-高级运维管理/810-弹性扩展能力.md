---
show: step
version: 3.0
enable_checker: true
---



# 数据库弹性扩展能力

## 课程介绍

本课程主要介绍 SequoiaDB 巨杉数据库的弹性扩展能力。同时受限于实验环境，数据库节点均在同一台服务器上演示，扩展步骤和原理与在多台服务器上原理保持一致。

#### 部署架构

本课程中的 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本。

![810-1](https://doc.shiyanlou.com/courses/1544/1207281/edad10d1fca39ab74e2d0a1c01d34154)

关于 SequoiaDB 巨杉数据库系统架构的详细信息，请参考如下链接：

* [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。

## 切换用户及查看数据库版本

#### 切换到 sdbadmin 用户

部署 SequoiaDB 巨杉数据库和 SequoiaSQL-MySQL 实例的操作系统用户为 sdbadmin。

```shell
su - sdbadmin
```

>Note:
>
>用户 sdbadmin 的密码为 `sdbadmin`

#### 查看巨杉数据库版本

查看 SequoiaDB 巨杉数据库引擎版本：

```shell
sequoiadb --version
```

操作截图：

![810-2](https://doc.shiyanlou.com/courses/1469/1207281/b4082b0d6d6bdf89d229aa713a53759d)

## 查看节点启动列表

查看 SequoiaDB 巨杉数据库引擎节点列表：

```shell
sdblist
```

操作截图：

![810-3](https://doc.shiyanlou.com/courses/1469/1207281/02fcaa58ac27e91688ead137fa748d6e)

>Note:
>
>如果显示的节点数量与预期不符，请稍等节点初始化完成后再重试该步骤。

## 创建域、集合空间、集合

创建数据域、集合空间和集合，为集群扩容后数据重分布做准备。

1）通过 Linux 命令行进入 SequoiaDB Shell；

```shell
sdb
```

2）通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ( "localhost", 11810 ) ;
```

3）创建 company_domain 逻辑域；

```javascript
db.createDomain ( "company_domain", ["group1", "group2", "group3"], { AutoSplit : true } ) ;
```

4）创建 company 集合空间；

```javascript
db.createCS ( "company", { Domain : "company_domain" } ) ;
```

5）创建 employee 集合；

```javascript
db.company.createCL ( "employee", { "ShardingKey" : { "_id" : 1 } , "ShardingType" : "hash" , "ReplSize" : -1 , "Compressed" : true , "CompressionType" : "lzw" , "AutoSplit" : true , "EnsureShardingIndex" : false } ) ;
```

6）使用 JavaScript 的 for 循环向  employee 集合中写入 1000 条数据；

```javascript
for (var i = 0 ; i < 1000 ; i++) {
    var record = {empno: i, ename : "TEST", age : 20} ;
    db.company.employee.insert (record) ;
}
```

## 数据库扩展

本次实验所有扩展均在一台服务器上完成，多服务器扩展原理与此相同。在当前分区组中创建节点，语法：

```javascript
rg.createNode( <host>, <service>, <dbpath>, [config] ) ;
```

参数描述：

| 参数名 | 参数类型   | 描述 | 是否必填 |
| ----- | --------- | ----------- | ------- |
| host | string | 指定节点的主机名。 | 是 |
| service  | 	int/string     | 节点端口号。    | 是 |
| dbpath  | string     | 1. 数据文件路径，用于存放节点数据文件，请确保数据管理员（安装时创建，默认为 sdbadmin ）用户有写权限； <br> 2. 如果配置路径不以“/”开头，数据文件存放路径将是数据库管理员用户（默认为 sdbadmin ）的主目录（默认为 /home/sequoiadb ）+ 配置的路径。    | 是 |
| config  | Json 对象     | 节点配置信息，如配置日志大小，是否打开事务等，具体可参考数据库配置。    | 否 |

### 新增数据节点

1）新增数据组；

```javascript
var dataRG = db.createRG ("group4") ;
```

2）添加数据节点；

```javascript
var dataNode=dataRG.createNode("sdbserver1", 11850, "/opt/sequoiadb/database/data/11850/", { logfilenum : 5 , transactionon : true } ) ;
```

3）启动新增数据节点；

```javascript
dataNode.start() ;
```

4）退出 SequoiaDB Shell；

```javascript
quit ;
```

5）查看数据库扩展后状态

```shell
sdblist  -t all -l -m local
```

操作截图：

 ![810-4](https://doc.shiyanlou.com/courses/1544/1207281/cbd113c6f1cb77ad20ebffe44c44a80d-0)

此时新增的编目节点和数据节点已经加入集群。

> Note:
>
> 如果是在新服务器上进行扩容，新增服务器的 hostname 和 ip 地址需要添加到所有服务器的 /etc/hostname 文件中。

### 数据重分布

集群扩容后，需要把原有数据域进行修改，新增数据组，并可通过 split 对已存在集合进行数据重新打散，达到集合数据均匀分布。

1）通过 Linux 命令行进入 SequoiaDB Shell；

```shell
sdb
```

2）通过 javascript 语言连接协调节点，获取数据库连接；

```javascript
var db = new Sdb ( "localhost", 11810 ) ;
```

3）数据域 company_domain 增加数据组；

```javascript
db.getDomain ( "company_domain" ).addGroups ( { Groups: ['group4'] } );
```

4）查看域信息；

```javascript
db.listDomains () ;
```

5）将集合的部分数据迁移到新的数据组上；

将 group1 数据组部分数据切分到新的数据组中：

```javascript
db.company.employee.split ( "group1", "group4", 25 ) ;
```

将 group2 数据组部分数据切分到新的数据组中：

```javascript
db.company.employee.split ( "group2", "group4", 25 ) ;
```

将 group3 数据组部分数据切分到新的数据组中：

```javascript
db.company.employee.split ( "group3", "group4", 25 ) ;
```

>Note:
>
> 以上split的含义时是把 group1、group2 和 group3 上的数据分别移25%到 group4 上。
> split 方法的详细说明请参考：[split 方法说明](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1432190844-edition_id-304)。

6）通过查看集合快照信息，获取集合分区情况；

```javascript
db.snapshot ( SDB_SNAP_COLLECTIONS ,{"Name": "company.employee"}) ;
```

#### 分析数据分布

1）连接第一个数据分区的存储节点；

```javascript
var db1 = new Sdb ( "localhost", 11820 ) ;
```

2）统计第一个数据分区的数据量；

```javascript
db1.company.employee.count () ;
```

3）连接第二个数据分区的存储节点；

```javascript
var db2 = new Sdb ( "localhost", 11830 ) ;
```

4）统计第二个数据分区的数据量；

```javascript
db2.company.employee.count () ;
```

5）连接第三个数据分区的存储节点；

```javascript
var db3 = new Sdb ( "localhost", 11840 ) ;
```

6）统计第三个数据分区的数据量；

```javascript
db3.company.employee.count () ;
```

7）连接第四个数据分区的存储节点；

```javascript
var db4 = new Sdb ( "localhost", 11850 ) ;
```

8）统计第四个数据分区的数据量；

```javascript
db4.company.employee.count () ;
```

## 总结

通过本课程，我们学会了如何在已有节点的数据库集群中实现弹性扩容，增加数据节点及集合数据的重新分布。
